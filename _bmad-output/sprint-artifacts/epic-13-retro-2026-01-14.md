# Epic 13 Retrospective: Unified Platform Cost Service

**Date:** 2026-01-14
**Facilitator:** Bob (Scrum Master)
**Epic:** [Epic 13: Unified Platform Cost Service](_bmad-output/epics/epic-13-platform-cost.md)
**ADR:** ADR-016 (Unified Cost Model and Platform Cost Service)

---

## Executive Summary

Epic 13 delivered a complete cost tracking overhaul for the Farmer Power Platform, moving from distributed cost storage in individual services to a unified, centralized platform-cost service. All 8 stories completed successfully with 838+ unit tests and 118 E2E tests passing. The epic unblocks Story 9.6 (LLM Cost Dashboard) in Epic 9.

---

## Delivery Metrics

| Metric | Target | Actual | Status |
|--------|--------|--------|--------|
| Stories Completed | 8 | 8 | ✅ |
| Story Points | 33 | 33 | ✅ |
| Unit Tests Added | - | 838+ | ✅ |
| E2E Tests | - | 118 | ✅ |
| Code Review Issues Fixed | - | 11 | ✅ |
| ADRs Implemented | 1 | 1 | ✅ |

### Story Breakdown

| Story | Points | Status | Key Achievement |
|-------|--------|--------|-----------------|
| 13.1 Shared Cost Event Model | 2 | Done | CostRecordedEvent in fp-common, 26 tests |
| 13.2 Platform Cost Service Scaffold | 3 | Done | FastAPI + DAPR + gRPC scaffold, 14 tests |
| 13.3 Cost Repository & Budget Monitor | 5 | Done | MongoDB repos, OTEL metrics, warm-up, 77 tests |
| 13.4 gRPC UnifiedCostService | 5 | Done | Proto + all RPC implementations, 92 tests |
| 13.5 DAPR Cost Event Subscription | 3 | Done | Streaming subscription handler, 108 tests |
| 13.6 BFF Integration Layer | 5 | Done | fp-common models, converters, BFF client, 132+ tests |
| 13.7 AI Model Refactor | 5 | Done | Publisher pattern, legacy cleanup, 838 tests |
| 13.8 E2E Integration Tests | 5 | Done | Full pub/sub flow validation, 118 E2E tests |

---

## What Went Well

### 1. ADR-Driven Development

ADR-016 provided exceptional architectural clarity. Every story knew exactly what it needed to deliver because the decision document laid it out clearly. No mid-story pivots occurred.

### 2. Decimal Precision Handling

Consistent handling of currency values across the entire stack:
- Storage: Decimal as strings in MongoDB
- Proto: String representation for precision
- Models: Pydantic Decimal with PlainSerializer
- Result: Zero precision loss in any tests

### 3. Shared Library Strategy

Moving `CostRecordedEvent` and response models to fp-common eliminated duplication across platform-cost, BFF, and ai-model. This pattern should continue for future cross-service models.

### 4. E2E Test Infrastructure

Story 13.8 added platform-cost to docker-compose seamlessly. The polling pattern with timeouts (5-10s wait, 0.5s intervals) handled DAPR's async propagation effectively. 118 E2E tests now validate the complete flow.

### 5. DAPR Pattern Reuse

The `asyncio.run_coroutine_threadsafe()` pattern documented in Epic 0.6 was successfully applied in Story 13.5, saving significant debugging time.

### 6. Code Review Effectiveness

Code review caught 3 high-severity issues:
- 13.6: AC5 not implemented (converters not wired up)
- 13.8: Missing pyproject.toml dependencies
- 13.3: Cost type accumulation bug (= instead of +=)

---

## Challenges Encountered

### 1. AC Completion Verification Gap (HIGH)

**Issue:** Story 13.6 AC5 was marked complete but the code changes were never committed.

**Resolution:** Code review caught it; fix committed (021a2ed).

**Root Cause:** No systematic verification that each AC has corresponding code in the diff.

### 2. Dependency Declaration Gap (MEDIUM)

**Issue:** Story 13.8 pyproject.toml was missing gRPC dependencies. Service imported grpcio but relied on transitive dependencies.

**Resolution:** Added grpcio, grpcio-health-checking, grpcio-reflection, dapr to pyproject.toml.

**Root Cause:** No checklist item to verify imports match declared dependencies.

### 3. GitHub Issue Update Skipped (MEDIUM)

**Issue:** Step 9c (update GitHub issue with completion status) was frequently skipped by agents.

**Resolution:** Will add verification check to code-review workflow (see Action Items).

**Root Cause:** Too many sequential steps at end of workflow; enforcement needed.

### 4. DAPR Event Timing (LOW)

**Issue:** E2E tests required trial-and-error to find correct wait times for async event propagation.

**Resolution:** Standardized on 5-10 second waits with 0.5s polling intervals.

---

## Action Items

### Process Improvements

| # | Action Item | Owner | Deadline | Success Criteria |
|---|-------------|-------|----------|------------------|
| 1 | Add self-review checklist to dev-story workflow | Scrum Master | Before Epic 9 | 5-item checklist as mandatory step before code review |
| 2 | Add GitHub issue verification to code-review workflow | Scrum Master | Before Epic 9 | Code review blocks if issue not updated |
| 3 | Document decimal-as-string pattern in project-context.md | Architect + Dev | Before Epic 9 | Currency handling pattern with code example |

### Self-Review Checklist (To Be Added)

| # | Check | Catches |
|---|-------|---------|
| 1 | For each AC, verify code change exists in git diff | AC implementation gaps |
| 2 | All imports declared in pyproject.toml | Dependency declaration gaps |
| 3 | Run full test suite locally | Regressions |
| 4 | Review story file sections are complete | Documentation gaps |
| 5 | Check for hardcoded values that should be config | Tech debt |

### Technical Debt

| # | Item | Priority | Notes |
|---|------|----------|-------|
| 1 | CORS allows all origins in platform-cost | MEDIUM | Needs production config |
| 2 | Hardcoded 5s DAPR timeout | LOW | Should be configurable |

### Documentation

| # | Item | Owner |
|---|------|-------|
| 1 | Add DAPR event timing guidance to E2E-TESTING-MENTAL-MODEL.md | Test Architect |
| 2 | Document CostRecordedEvent field mapping in API docs | Dev |

---

## Previous Retrospective Follow-Through

### Epic 0.6 Action Items Status

| # | Action Item | Status | Evidence in Epic 13 |
|---|-------------|--------|---------------------|
| 1 | Document DAPR threading model | ✅ Applied | Story 13.5 used pattern correctly |
| 2 | Add Infrastructure Requirements to ADR template | ✅ Applied | ADR-016 listed all requirements |
| 3 | Create pre-development self-review checklist | ⏳ Partial | Still catching issues in code review |
| 4 | Document E2E timeout rationale | ✅ Applied | Story 13.8 used proper timeouts |

**Assessment:** 3/4 fully applied. Self-review checklist remains a gap - addressed in this retro's action items.

---

## Impact on Next Epic

### Epic 9: Platform Admin Portal

Epic 13 unblocks **Story 9.6: LLM Cost Dashboard**. The PlatformCostClient from Story 13.6 provides:

- `get_cost_summary()` - Total costs with type breakdown
- `get_daily_trend()` - Daily costs for stacked charts
- `get_current_day_cost()` - Real-time today's cost
- `get_llm_cost_by_agent_type()` - LLM breakdown by agent
- `get_llm_cost_by_model()` - LLM breakdown by model
- `get_document_cost_summary()` - Document processing costs
- `get_embedding_cost_by_domain()` - Embedding costs by domain
- `get_budget_status()` - Current thresholds and utilization
- `configure_budget_threshold()` - Update thresholds

### Preparation Required

1. **Party-mode session** to review all Epic 9 stories
2. **Update Story 9.6** to reference actual PlatformCostClient methods
3. **Verify Epic 9 dependencies** are current

---

## Key Technical Decisions Validated

| Decision | Stories | Outcome |
|----------|---------|---------|
| Decimal as String | 13.1, 13.3, 13.4, 13.6 | Zero precision loss |
| Best-Effort Publishing | 13.7 | Graceful degradation works |
| Warm-up on Startup | 13.3, 13.5 | BudgetMonitor survives restarts |
| Proto = Source of Truth | 13.4, 13.8 | E2E tests validate, don't define |
| Streaming Subscriptions | 13.5 | Simpler than HTTP POST handlers |

---

## Team Feedback

**What the team wants to keep doing:**
- ADR-first approach for complex epics
- Code review as mandatory gate
- Shared library strategy for cross-service models
- E2E tests covering complete integration flows

**What the team wants to improve:**
- Self-review before code review (checklist)
- GitHub issue updates (workflow enforcement)
- Documentation of timing/retry patterns

---

## Retrospective Outcome

**Epic 13: Unified Platform Cost Service** delivered successfully with all 8 stories completed, 33 story points, 838+ unit tests, and 118 E2E tests. The key achievements:

1. Centralized cost tracking via platform-cost service
2. Clean ai-model refactor (removed 4 legacy files)
3. Type-safe BFF integration with PlatformCostClient
4. Story 9.6 (LLM Cost Dashboard) now unblocked

**Next Steps:**
1. Complete action items before Epic 9 starts
2. Run party-mode session to review Epic 9 stories
3. Begin Epic 9: Platform Admin Portal

---

*Retrospective facilitated by Bob (Scrum Master) using BMAD retrospective workflow.*
