# Epic 0.6 Retrospective: Infrastructure Hardening

**Date:** 2026-01-02
**Facilitator:** Bob (Scrum Master)
**Epic:** [Epic 0.6: Infrastructure Hardening](../epics/epic-0-6-infrastructure-hardening.md)
**Duration:** Wave 1-3 (Foundation → DAPR SDK → Domain Logic)

---

## Executive Summary

Epic 0.6 delivered comprehensive infrastructure hardening across 10 stories (35 story points), implementing 8 ADRs (004-011). All stories completed with code review, adding ~180 unit tests. The epic established critical patterns for DAPR streaming subscriptions, gRPC retry logic, and observability metrics that will benefit future development.

---

## Delivery Metrics

| Metric | Target | Actual | Status |
|--------|--------|--------|--------|
| Stories Completed | 10 | 10 | ✅ |
| Story Points | 35 | 35 | ✅ |
| ADRs Implemented | 8 | 8 | ✅ |
| Unit Tests Added | - | ~180 | ✅ |
| E2E Tests | Pass | Pass | ✅ |
| Code Review Issues | - | ~35 fixed | ✅ |

### Story Breakdown

| Story | Points | Status | Key Achievement |
|-------|--------|--------|-----------------|
| 0.6.1 Shared Pydantic Models | 3 | Done | 86 tests, fp-common consolidation |
| 0.6.2 Shared Logging Module | 3 | Done | 23 tests, runtime level control |
| 0.6.3 gRPC Retry AI Model Client | 3 | Done | 16 tests, Tenacity pattern |
| 0.6.4 gRPC Retry Iteration Resolver | 3 | Done | 24 tests, timeout optimization |
| 0.6.5 Plantation Streaming | 5 | Done | Event loop fix discovery |
| 0.6.6 Collection Streaming | 5 | Done | 14 tests, pattern reuse |
| 0.6.7 DAPR Resiliency Config | 2 | Done | YAML-only, exponential backoff |
| 0.6.8 Dead Letter Queue Handler | 3 | Done | 19 tests, MongoDB storage |
| 0.6.9 Source Config Cache | 5 | Done | 15 tests, change streams |
| 0.6.10 Linkage Field Validation | 3 | Done | 32 tests, all 4 fields |

---

## What Went Well

### 1. Event Loop Threading Pattern Discovery

The most significant technical achievement was discovering and documenting the DAPR streaming handler threading model. When DAPR subscription handlers run in separate threads, async code requires explicit event loop coordination.

**The Pattern:**
```python
# Store main event loop at startup
_main_event_loop: asyncio.AbstractEventLoop | None = None

def set_main_event_loop(loop: asyncio.AbstractEventLoop) -> None:
    global _main_event_loop
    _main_event_loop = loop

# In DAPR subscription handler (runs in separate thread)
def handle_event(message) -> TopicEventResponse:
    if _main_event_loop is None:
        return TopicEventResponse("retry")

    future = asyncio.run_coroutine_threadsafe(
        async_processor(...),
        _main_event_loop,
    )
    result = future.result(timeout=30)
    return TopicEventResponse("success")
```

**Impact:** This pattern was discovered in Story 0.6.5 and immediately applied to Story 0.6.6, saving significant debugging time.

### 2. ADR Implementation Coverage

Implemented 8 ADRs in a single epic:
- **ADR-004:** Shared Pydantic Models
- **ADR-005:** Structured Logging with Runtime Control
- **ADR-006:** Event Delivery and Dead Letter Queue
- **ADR-007:** gRPC Retry with Tenacity
- **ADR-008:** Change Stream Cache Invalidation
- **ADR-009:** DAPR Streaming Subscriptions
- **ADR-010:** DLQ MongoDB Storage Pattern
- **ADR-011:** Linkage Field Validation with Metrics

### 3. Test Coverage Growth

Added ~180 unit tests across 10 stories with consistent quality:
- Golden sample patterns for AI agent testing
- Mock patterns standardized across services
- E2E mental model (Proto → Code → Seed → Tests) validated

### 4. Wave Structure Effectiveness

The three-wave approach created natural dependencies:
- **Wave 1 (Foundation):** Shared libraries enabled Wave 2
- **Wave 2 (DAPR SDK):** Infrastructure patterns enabled Wave 3
- **Wave 3 (Domain Logic):** Built on hardened foundation

---

## Challenges Encountered

### 1. DAPR Streaming Thread Model (HIGH)

**Issue:** DAPR documentation doesn't clearly explain that streaming subscription handlers run in separate threads, causing async handler deadlocks.

**Resolution:** Discovered `asyncio.run_coroutine_threadsafe()` pattern through debugging. Added explicit documentation in story files.

**Time Impact:** Story 0.6.5 extended by debugging time.

### 2. MongoDB Replica Set Requirement (MEDIUM)

**Issue:** Change Streams (Story 0.6.9) require MongoDB replica set, which wasn't explicit in ADR-008.

**Resolution:** Updated E2E infrastructure to use replica set configuration.

**Lesson:** ADRs should explicitly list infrastructure requirements.

### 3. gRPC Timeout Tuning (MEDIUM)

**Issue:** E2E tests required longer timeouts (30s) than unit tests due to infrastructure startup variability.

**Resolution:** Standardized on 30s timeout for E2E, documented rationale.

### 4. Code Review Issue Volume (LOW)

**Issue:** ~35 issues found across all stories, mostly LOW/MEDIUM severity (docstrings, naming, error handling).

**Resolution:** All issues fixed. Need self-review checklist to catch earlier.

---

## Action Items

### For Next Epic

| # | Action Item | Owner | Acceptance Criteria |
|---|-------------|-------|---------------------|
| 1 | Document DAPR threading model in project-context.md | Architect | Threading pattern with code example added |
| 2 | Add "Infrastructure Requirements" section to ADR template | Architect | Template updated, existing ADRs reviewed |
| 3 | Create pre-development self-review checklist | Senior Dev | Checklist in project-context.md |
| 4 | Document E2E timeout rationale | Test Architect | Timeout guidance in E2E-TESTING-MENTAL-MODEL.md |

### Epic 2 Action Items - Completion Status

| Epic 2 Action Item | Status | Evidence |
|-------------------|--------|----------|
| Standardize gRPC retry pattern | ✅ Done | ADR-007 + Stories 0.6.3, 0.6.4 |
| Document streaming subscription pattern | ✅ Done | ADR-009 + Stories 0.6.5, 0.6.6 |
| Add observability metrics | ✅ Done | ADR-008 + Story 0.6.10 |
| Create shared test utilities | ✅ Done | fp-testing fixtures enhanced |

---

## Key Technical Decisions

### Validated Patterns

1. **Tenacity for gRPC Retry:** Exponential backoff with jitter, singleton channel pattern
2. **TopicEventResponse:** success/retry/drop semantics for DAPR pub/sub
3. **Change Streams:** Real-time cache invalidation with resume tokens
4. **DLQ Storage:** MongoDB collection with TTL index for automatic cleanup
5. **Linkage Validation:** Centralized validation with OpenTelemetry metrics

### Deferred Items

None - all planned scope delivered.

---

## Impact on Next Epic

Story 0-4-9 (Training Feedback Loop) is now unblocked. The infrastructure hardening provides:

- **Reliable event delivery** via DAPR resiliency config
- **Observable failures** via linkage validation metrics
- **Cache consistency** via change stream invalidation
- **Error recovery** via DLQ handler for failed events

---

## Team Feedback

**What the team wants to keep doing:**
- Wave-based epic structure with clear dependencies
- Code review as mandatory gate before done
- Documenting discoveries in story files for future reference

**What the team wants to improve:**
- Earlier identification of infrastructure requirements
- Self-review before code review to catch common issues
- Better DAPR documentation for async patterns

---

## Retrospective Outcome

**Epic 0.6: Infrastructure Hardening** delivered successfully with all 10 stories completed, 8 ADRs implemented, and ~180 unit tests added. The key learning (DAPR threading model) is documented for future teams. Four action items identified for process improvement in future epics.

**Next Steps:**
1. Complete action items before next epic starts
2. Begin Story 0-4-9 (Training Feedback Loop)
3. Monitor DLQ and linkage validation metrics in staging

---

*Retrospective facilitated by Bob (Scrum Master) using BMAD retrospective workflow.*
