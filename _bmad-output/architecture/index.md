# Architecture Decision Document

## Table of Contents

- [Architecture Decision Document](#table-of-contents)
  - [stepsCompleted: [1]
inputDocuments: ['_bmad-output/analysis/product-brief-farmer-power-platform-2025-12-16.md']
workflowType: 'architecture'
lastStep: 1
project_name: 'farmer-power-platform'
user_name: 'Jeanlouistournay'
date: '2025-12-16'](#stepscompleted-1-inputdocuments-bmad-outputanalysisproduct-brief-farmer-power-platform-2025-12-16md-workflowtype-architecture-laststep-1-projectname-farmer-power-platform-username-jeanlouistournay-date-2025-12-16)
  - [Architecture Decision Records (ADRs)](./adr/index.md)
    - [ADR-001: Weather API Selection](./adr/ADR-001-weather-api-selection.md)
    - [ADR-002: Frontend Architecture](./adr/ADR-002-frontend-architecture.md)
    - [ADR-003: Identity & Access Management](./adr/ADR-003-identity-access-management.md)
  - [Source of Truth Declaration](./source-of-truth-declaration.md)
    - [Platform Model Overview (9 Models)](./source-of-truth-declaration.md#platform-model-overview-9-models)
  - [Collection Model Architecture](./collection-model-architecture.md)
    - [Overview](./collection-model-architecture.md#overview)
    - [Architecture Diagram](./collection-model-architecture.md#architecture-diagram)
    - [Configured Sources](./collection-model-architecture.md#configured-sources)
    - [Ingestion Pipeline](./collection-model-architecture.md#ingestion-pipeline)
      - [Step 1: Schema Validation](./collection-model-architecture.md#step-1-schema-validation)
      - [Step 2: LLM Agent Extraction + Validation](./collection-model-architecture.md#step-2-llm-agent-extraction-validation)
      - [Step 3: Farmer Linkage](./collection-model-architecture.md#step-3-farmer-linkage)
      - [Step 4: Document Storage](./collection-model-architecture.md#step-4-document-storage)
    - [Trust Model](./collection-model-architecture.md#trust-model)
    - [Retrieval APIs](./collection-model-architecture.md#retrieval-apis)
      - [Query API](./collection-model-architecture.md#query-api)
      - [Search API](./collection-model-architecture.md#search-api)
      - [MCP Server Tools](./collection-model-architecture.md#mcp-server-tools)
    - [Testing Strategy](./collection-model-architecture.md#testing-strategy)
    - [Data Flow Example](./collection-model-architecture.md#data-flow-example)
  - [Knowledge Model Architecture](./knowledge-model-architecture.md)
    - [Overview](./knowledge-model-architecture.md#overview)
    - [Architecture Diagram](./knowledge-model-architecture.md#architecture-diagram)
    - [Three-Tier Agent Pattern](./knowledge-model-architecture.md#three-tier-agent-pattern)
      - [Tier 1: Explorer Agent](./knowledge-model-architecture.md#tier-1-explorer-agent)
      - [Tier 2: Triage Agent (Event Path Only)](./knowledge-model-architecture.md#tier-2-triage-agent-event-path-only)
    - [LangGraph Saga Pattern (Parallel Analyzer Orchestration)](./knowledge-model-architecture.md#langgraph-saga-pattern-parallel-analyzer-orchestration)
      - [Tier 3: Specialized Analyzer Agents](./knowledge-model-architecture.md#tier-3-specialized-analyzer-agents)
    - [Weather Lag Correlation](./knowledge-model-architecture.md#weather-lag-correlation)
    - [Two Databases](./knowledge-model-architecture.md#two-databases)
      - [Analysis DB (MongoDB)](./knowledge-model-architecture.md#analysis-db-mongodb)
      - [Vector DB (Pinecone)](./knowledge-model-architecture.md#vector-db-pinecone)
    - [RAG Pattern](./knowledge-model-architecture.md#rag-pattern)
    - [Trigger Configuration](./knowledge-model-architecture.md#trigger-configuration)
    - [MCP Server Tools](./knowledge-model-architecture.md#mcp-server-tools)
    - [Key Decisions](./knowledge-model-architecture.md#key-decisions)
    - [Diagnosis Deduplication Strategy](./knowledge-model-architecture.md#diagnosis-deduplication-strategy)
    - [Testing Strategy](./knowledge-model-architecture.md#testing-strategy)
    - [Triage Feedback Loop](./knowledge-model-architecture.md#triage-feedback-loop)
      - [Feedback Loop Architecture](./knowledge-model-architecture.md#feedback-loop-architecture)
      - [Feedback Storage Schema](./knowledge-model-architecture.md#feedback-storage-schema)
      - [Improvement Pipeline](./knowledge-model-architecture.md#improvement-pipeline)
      - [Dapr Job Configuration](./knowledge-model-architecture.md#dapr-job-configuration)
      - [Few-Shot Example Generation](./knowledge-model-architecture.md#few-shot-example-generation)
      - [Metrics Tracked](./knowledge-model-architecture.md#metrics-tracked)
  - [Plantation Model Architecture](./plantation-model-architecture.md)
    - [Overview](./plantation-model-architecture.md#overview)
    - [Architecture Diagram](./plantation-model-architecture.md#architecture-diagram)
    - [Region Entity](./plantation-model-architecture.md#region-entity)
    - [Data Ownership](./plantation-model-architecture.md#data-ownership)
    - [Farmer Power Ecosystem Context](./plantation-model-architecture.md#farmer-power-ecosystem-context)
    - [Performance Summary Computation (Hybrid Approach)](./plantation-model-architecture.md#performance-summary-computation-hybrid-approach)
    - [API Structure](./plantation-model-architecture.md#api-structure)
      - [Admin UI Endpoints (authenticated, role-based)](./plantation-model-architecture.md#admin-ui-endpoints-authenticated-role-based)
      - [Internal Endpoints (service-to-service)](./plantation-model-architecture.md#internal-endpoints-service-to-service)
    - [MCP Server Tools](./plantation-model-architecture.md#mcp-server-tools)
    - [Key Decisions](./plantation-model-architecture.md#key-decisions)
    - [Testing Strategy](./plantation-model-architecture.md#testing-strategy)
  - [Action Plan Model Architecture](./action-plan-model-architecture.md)
    - [Overview](./action-plan-model-architecture.md#overview)
    - [Architecture Diagram](./action-plan-model-architecture.md#architecture-diagram)
    - [Two-Agent Pattern](./action-plan-model-architecture.md#two-agent-pattern)
      - [Selector Agent](./action-plan-model-architecture.md#selector-agent)
      - [Action Plan Generator Agent](./action-plan-model-architecture.md#action-plan-generator-agent)
    - [Dual-Format Output](./action-plan-model-architecture.md#dual-format-output)
    - [Farmer Communication Preferences](./action-plan-model-architecture.md#farmer-communication-preferences)
    - [Translation and Simplification](./action-plan-model-architecture.md#translation-and-simplification)
    - [Empty State Handling](./action-plan-model-architecture.md#empty-state-handling)
    - [No MCP Server](./action-plan-model-architecture.md#no-mcp-server)
    - [Message Delivery Separation](./action-plan-model-architecture.md#message-delivery-separation)
    - [Unified Notification Infrastructure](./action-plan-model-architecture.md#unified-notification-infrastructure)
    - [SMS Cost Optimization Strategy](./action-plan-model-architecture.md#sms-cost-optimization-strategy)
      - [SMS Character Economics](./action-plan-model-architecture.md#sms-character-economics)
      - [Tiered Message Strategy](./action-plan-model-architecture.md#tiered-message-strategy)
      - [Transliteration Strategy](./action-plan-model-architecture.md#transliteration-strategy)
      - [Cost Projection (800,000 farmers)](./action-plan-model-architecture.md#cost-projection-800000-farmers)
      - [Message Generation Configuration](./action-plan-model-architecture.md#message-generation-configuration)
    - [Voice IVR System](./action-plan-model-architecture.md#voice-ivr-system)
      - [Voice IVR Architecture](./action-plan-model-architecture.md#voice-ivr-architecture)
      - [Voice IVR Call Flow](./action-plan-model-architecture.md#voice-ivr-call-flow)
      - [TTS Engine Configuration](./action-plan-model-architecture.md#tts-engine-configuration)
      - [SMS â†’ Voice Handoff](./action-plan-model-architecture.md#sms-voice-handoff)
      - [Action Plan to Voice Script Conversion](./action-plan-model-architecture.md#action-plan-to-voice-script-conversion)
      - [Voice IVR Cost Model](./action-plan-model-architecture.md#voice-ivr-cost-model)
    - [Two-Way Communication](./action-plan-model-architecture.md#two-way-communication)
      - [Inbound Message Flow](./action-plan-model-architecture.md#inbound-message-flow)
      - [Keyword Commands (No LLM)](./action-plan-model-architecture.md#keyword-commands-no-llm)
      - [Free Text AI Triage](./action-plan-model-architecture.md#free-text-ai-triage)
      - [Intent Routing](./action-plan-model-architecture.md#intent-routing)
      - [Cost Projection](./action-plan-model-architecture.md#cost-projection)
      - [Inbound Webhook Configuration](./action-plan-model-architecture.md#inbound-webhook-configuration)
    - [Message Delivery Assurance Strategy](./action-plan-model-architecture.md#message-delivery-assurance-strategy)
      - [Delivery Flow](./action-plan-model-architecture.md#delivery-flow)
      - [Delivery Configuration](./action-plan-model-architecture.md#delivery-configuration)
      - [Multi-Channel Fallback (Critical Alerts Only)](./action-plan-model-architecture.md#multi-channel-fallback-critical-alerts-only)
      - [Catch-Up Message for Recovered Farmers](./action-plan-model-architecture.md#catch-up-message-for-recovered-farmers)
      - [Lead Farmer Escalation](./action-plan-model-architecture.md#lead-farmer-escalation)
      - [Delivery Assurance Cost Impact](./action-plan-model-architecture.md#delivery-assurance-cost-impact)
    - [Group Messaging Architecture](./action-plan-model-architecture.md#group-messaging-architecture)
      - [Messaging Tiers](./action-plan-model-architecture.md#messaging-tiers)
      - [Group Entity (Plantation Model)](./action-plan-model-architecture.md#group-entity-plantation-model)
      - [Broadcast Configuration](./action-plan-model-architecture.md#broadcast-configuration)
      - [Lead Farmer Cascade](./action-plan-model-architecture.md#lead-farmer-cascade)
      - [Cost Optimization via Grouping](./action-plan-model-architecture.md#cost-optimization-via-grouping)
      - [Implementation Priority](./action-plan-model-architecture.md#implementation-priority)
    - [Key Decisions](./action-plan-model-architecture.md#key-decisions)
    - [Testing Strategy](./action-plan-model-architecture.md#testing-strategy)
  - [Market Analysis Model Architecture](./market-analysis-model-architecture.md)
    - [Overview](./market-analysis-model-architecture.md#overview)
    - [Known Data Sources](./market-analysis-model-architecture.md#known-data-sources)
    - [Starfish Network Integration](./market-analysis-model-architecture.md#starfish-network-integration)
    - [Known Outputs](./market-analysis-model-architecture.md#known-outputs)
    - [Open Questions (To Discuss)](./market-analysis-model-architecture.md#open-questions-to-discuss)
    - [Architecture Diagram](./market-analysis-model-architecture.md#architecture-diagram)
  - [AI Model Architecture](./ai-model-architecture.md)
    - [Overview](./ai-model-architecture.md#overview)
    - [Architecture Diagram](./ai-model-architecture.md#architecture-diagram)
    - [Communication Pattern](./ai-model-architecture.md#communication-pattern)
    - [Agent Types](./ai-model-architecture.md#agent-types)
      - [Extractor Type](./ai-model-architecture.md#extractor-type)
      - [Explorer Type](./ai-model-architecture.md#explorer-type)
      - [Generator Type](./ai-model-architecture.md#generator-type)
    - [Agent Configuration Schema](./ai-model-architecture.md#agent-configuration-schema)
    - [Agent Type Design Decisions](./ai-model-architecture.md#agent-type-design-decisions)
    - [Triggering](./ai-model-architecture.md#triggering)
    - [LLM Gateway](./ai-model-architecture.md#llm-gateway)
    - [Tiered Vision Processing (Cost Optimization)](./ai-model-architecture.md#tiered-vision-processing-cost-optimization)
    - [RAG Engine](./ai-model-architecture.md#rag-engine)
    - [Prompt Management](./ai-model-architecture.md#prompt-management)
      - [Prompt Storage Architecture](./ai-model-architecture.md#prompt-storage-architecture)
      - [Prompt Document Schema](./ai-model-architecture.md#prompt-document-schema)
      - [Prompt Lifecycle](./ai-model-architecture.md#prompt-lifecycle)
      - [Runtime Prompt Loading](./ai-model-architecture.md#runtime-prompt-loading)
      - [Prompt A/B Testing](./ai-model-architecture.md#prompt-ab-testing)
      - [Key Benefits](./ai-model-architecture.md#key-benefits)
    - [RAG Knowledge Versioning](./ai-model-architecture.md#rag-knowledge-versioning)
      - [Document Lifecycle](./ai-model-architecture.md#document-lifecycle)
      - [Document Schema](./ai-model-architecture.md#document-schema)
      - [A/B Testing Configuration](./ai-model-architecture.md#ab-testing-configuration)
      - [Rollback Procedure](./ai-model-architecture.md#rollback-procedure)
      - [Version Lifecycle Flow](./ai-model-architecture.md#version-lifecycle-flow)
    - [Configuration Strategy](./ai-model-architecture.md#configuration-strategy)
    - [Observability](./ai-model-architecture.md#observability)
    - [Key Decisions](./ai-model-architecture.md#key-decisions)
    - [Testing Strategy](./ai-model-architecture.md#testing-strategy)
    - [Developer Guide](./ai-model-architecture.md#developer-guide)
  - [Infrastructure Decisions](./infrastructure-decisions.md)
    - [MCP Server Scaling](./infrastructure-decisions.md#mcp-server-scaling)
    - [External API Resiliency (DAPR Circuit Breaker)](./infrastructure-decisions.md#external-api-resiliency-dapr-circuit-breaker)
    - [Kubernetes Deployment Architecture](./infrastructure-decisions.md#kubernetes-deployment-architecture)
      - [Multi-Environment Strategy](./infrastructure-decisions.md#multi-environment-strategy)
      - [Namespace Service Organization](./infrastructure-decisions.md#namespace-service-organization)
      - [Communication Protocol Strategy](./infrastructure-decisions.md#communication-protocol-strategy)
      - [BFF Responsibilities](./infrastructure-decisions.md#bff-responsibilities)
      - [Deployment Manifest Summary](./infrastructure-decisions.md#deployment-manifest-summary)
      - [External Managed Services](./infrastructure-decisions.md#external-managed-services)
      - [Environment Configuration](./infrastructure-decisions.md#environment-configuration)
      - [Dapr Component Configuration (Per Namespace)](./infrastructure-decisions.md#dapr-component-configuration-per-namespace)
  - [Repository Structure](./repository-structure.md)
    - [Monorepo Decision](./repository-structure.md#monorepo-decision)
    - [Top-Level Directory Structure](./repository-structure.md#top-level-directory-structure)
    - [Service Folder Template](./repository-structure.md#service-folder-template)
    - [Proto Organization](./repository-structure.md#proto-organization)
    - [Shared Libraries](./repository-structure.md#shared-libraries)
    - [Docker Organization](./repository-structure.md#docker-organization)
    - [Kubernetes Manifests (Kustomize)](./repository-structure.md#kubernetes-manifests-kustomize)
    - [CI/CD Pipeline Structure](./repository-structure.md#cicd-pipeline-structure)
    - [Development Workflow](./repository-structure.md#development-workflow)
  - [Analytics Architecture](./analytics-architecture.md)
    - [Cross-Model Data Access Strategy](./analytics-architecture.md#cross-model-data-access-strategy)
      - [Consumer-Specific Strategies](./analytics-architecture.md#consumer-specific-strategies)
      - [AI Agent Queries (Production)](./analytics-architecture.md#ai-agent-queries-production)
      - [Admin Dashboard (Analytics Read Model)](./analytics-architecture.md#admin-dashboard-analytics-read-model)
      - [Materialized View Schema](./analytics-architecture.md#materialized-view-schema)
      - [Why NOT Other Options](./analytics-architecture.md#why-not-other-options)
  - [CQRS Architecture Pattern](./cqrs-architecture-pattern.md)
    - [Overview](./cqrs-architecture-pattern.md#overview)
    - [Read/Write Separation Layers](./cqrs-architecture-pattern.md#readwrite-separation-layers)
    - [MongoDB Read Replica Configuration](./cqrs-architecture-pattern.md#mongodb-read-replica-configuration)
    - [Query Patterns by Consumer](./cqrs-architecture-pattern.md#query-patterns-by-consumer)
    - [Why Implicit CQRS (Not Explicit)](./cqrs-architecture-pattern.md#why-implicit-cqrs-not-explicit)
    - [When to Evolve to Explicit CQRS](./cqrs-architecture-pattern.md#when-to-evolve-to-explicit-cqrs)
  - [Notification Model Architecture](./notification-model-architecture.md)
    - [Overview](./notification-model-architecture.md#overview)
    - [Architecture Diagram](./notification-model-architecture.md#architecture-diagram)
    - [Supported Channels](./notification-model-architecture.md#supported-channels)
    - [SMS Cost Optimization Strategy](./notification-model-architecture.md#sms-cost-optimization-strategy)
    - [Voice IVR System](./notification-model-architecture.md#voice-ivr-system)
    - [Inbound Message Handling](./notification-model-architecture.md#inbound-message-handling)
    - [Message Delivery Assurance Strategy](./notification-model-architecture.md#message-delivery-assurance-strategy)
    - [Group Messaging Architecture](./notification-model-architecture.md#group-messaging-architecture)
    - [Key Decisions](./notification-model-architecture.md#key-decisions)
    - [Testing Strategy](./notification-model-architecture.md#testing-strategy)
  - [Validated Use Cases](./validated-use-cases.md)
    - [Use Case 1: Batch ZIP Upload (Poor Quality Images)](./validated-use-cases.md#use-case-1-batch-zip-upload-poor-quality-images)
    - [Use Case 2: Image + Metadata Diagnosis](./validated-use-cases.md#use-case-2-image-metadata-diagnosis)
    - [Use Case 3: Weekly Action Plan Generation](./validated-use-cases.md#use-case-3-weekly-action-plan-generation)
    - [Use Case 4: Weather Data Pull and Correlation](./validated-use-cases.md#use-case-4-weather-data-pull-and-correlation)
    - [Use Case Summary](./validated-use-cases.md#use-case-summary)
    - [Event Flow Summary](./validated-use-cases.md#event-flow-summary)
  - [Conversational AI Model Architecture](./conversational-ai-model-architecture.md)
    - [Overview](./conversational-ai-model-architecture.md#overview)
    - [Architecture Diagram](./conversational-ai-model-architecture.md#architecture-diagram)
    - [Open-Closed Design Principle](./conversational-ai-model-architecture.md#open-closed-design-principle)
    - [Channel Adapter Interface](./conversational-ai-model-architecture.md#channel-adapter-interface)
    - [Voice Adapter (MVP)](./conversational-ai-model-architecture.md#voice-adapter-mvp)
    - [Integration with Existing Models](./conversational-ai-model-architecture.md#integration-with-existing-models)
    - [Persona Configuration](./conversational-ai-model-architecture.md#persona-configuration)
    - [Conversation State Management](./conversational-ai-model-architecture.md#conversation-state-management)
    - [SMS Fallback](./conversational-ai-model-architecture.md#sms-fallback)
    - [Cost Model](./conversational-ai-model-architecture.md#cost-model)
    - [Logging and Analytics](./conversational-ai-model-architecture.md#logging-and-analytics)
    - [Testing Strategy](./conversational-ai-model-architecture.md#testing-strategy)
    - [MVP vs Future Capabilities](./conversational-ai-model-architecture.md#mvp-vs-future-capabilities)
    - [Updated Model Overview](./conversational-ai-model-architecture.md#updated-model-overview)
  - [Engagement Model Architecture](./engagement-model-architecture.md)
    - [Overview](./engagement-model-architecture.md#overview)
    - [Architecture Diagram](./engagement-model-architecture.md#architecture-diagram)
    - [Core Concepts](./engagement-model-architecture.md#core-concepts)
    - [Streak Types](./engagement-model-architecture.md#streak-types)
    - [Streak Freeze (Compassion Logic)](./engagement-model-architecture.md#streak-freeze-compassion-logic)
    - [Data Model](./engagement-model-architecture.md#data-model)
    - [Milestone Definitions](./engagement-model-architecture.md#milestone-definitions)
    - [Motivation State Machine](./engagement-model-architecture.md#motivation-state-machine)
    - [Event Integration](./engagement-model-architecture.md#event-integration)
    - [MCP Server Tools](./engagement-model-architecture.md#mcp-server-tools)
    - [Message Personalization Context](./engagement-model-architecture.md#message-personalization-context)
    - [Engagement Score Calculation](./engagement-model-architecture.md#engagement-score-calculation)
    - [Key Decisions](./engagement-model-architecture.md#key-decisions)
    - [Anti-Patterns Avoided](./engagement-model-architecture.md#anti-patterns-avoided)
    - [Testing Strategy](./engagement-model-architecture.md#testing-strategy)
    - [Integration with Other Models](./engagement-model-architecture.md#integration-with-other-models)
  - [Test Architecture](../test-design-system-level.md)
    - [Architecture Testability Assessment](../test-design-system-level.md#architecture-testability-assessment)
    - [Risk Assessment](../test-design-system-level.md#risk-assessment-system-level)
    - [Test Strategy by Domain Model](../test-design-system-level.md#test-strategy-by-domain-model)
    - [Test Infrastructure Requirements](../test-design-system-level.md#test-infrastructure-requirements)
    - [Golden Sample Framework](../test-design-system-level.md#golden-sample-framework)
    - [Quality Gate Criteria](../test-design-system-level.md#quality-gate-criteria)
