<task id="_bmad/bmm/tasks/create-github-issue" name="Create GitHub Issue"
  description="Creates a GitHub issue from a story file for traceability between code and stories" standalone="true">

  <llm critical="true">
    <i>MANDATORY: Execute ALL steps in the flow section IN EXACT ORDER</i>
    <i>DO NOT skip steps or change the sequence</i>
    <i>HALT immediately when halt-conditions are met</i>
    <i>Each action xml tag within step xml tag is a REQUIRED action to complete that step</i>
    <i>Use GitHub MCP tools (mcp__github__*) for all GitHub operations</i>
  </llm>

  <config>
    <variable name="story_path" description="Path to story file (optional - will discover if not provided)" />
    <variable name="sprint_artifacts" source="{config_source}:sprint_artifacts" />
    <variable name="github_owner" description="GitHub repository owner (extracted from git remote)" />
    <variable name="github_repo" description="GitHub repository name (extracted from git remote)" />
  </config>

  <flow>
    <step n="1" title="Discover Story File">
      <check if="story_path is provided">
        <action>Use provided story_path directly</action>
        <action>Read the story file completely</action>
      </check>
      <check if="story_path is NOT provided">
        <action>Look for sprint-status.yaml in sprint_artifacts folder</action>
        <action>Find first story with status "ready-for-dev" or "in-progress"</action>
        <action>If no sprint-status.yaml, search sprint_artifacts for story files (pattern: *-*-*.md)</action>
        <action>Ask user to select story if multiple candidates found</action>
        <action>Read the selected story file completely</action>
      </check>
      <action>Extract story metadata: story_key (from filename), title (from # heading), status, acceptance criteria</action>
    </step>

    <step n="2" title="Check for Existing GitHub Issue">
      <action>Search story file for existing "GitHub Issue:" field</action>
      <check if="GitHub Issue field exists and has value">
        <action>Extract issue number from field</action>
        <action>Verify issue exists on GitHub using mcp__github__get_issue</action>
        <check if="issue exists">
          <output>Story already has GitHub Issue #{{issue_number}} linked. No action needed.</output>
          <action>HALT - Issue already exists</action>
        </check>
        <check if="issue does NOT exist">
          <action>Warn user that linked issue was not found, will create new one</action>
        </check>
      </check>
    </step>

    <step n="3" title="Extract GitHub Repository Info">
      <action>Run: git remote get-url origin</action>
      <action>Parse owner and repo from remote URL</action>
      <action>Handle both HTTPS (github.com/owner/repo.git) and SSH (git@github.com:owner/repo.git) formats</action>
      <action>Store github_owner and github_repo variables</action>
    </step>

    <step n="4" title="Prepare Issue Content">
      <action>Extract story title from # heading</action>
      <action>Extract story description (the "As a... I want... So that..." section)</action>
      <action>Extract acceptance criteria</action>
      <action>Get relative path to story file from repository root</action>

      <action>Format issue title: "Story {{story_key}}: {{story_title}}"</action>
      <action>Format issue body using template below</action>

      <template name="issue_body">
## Story

{{story_description}}

## Acceptance Criteria

{{acceptance_criteria}}

---

**Story File:** `{{story_file_path}}`

**Status:** {{story_status}}

---
*This issue was auto-generated by BMAD workflow for code-to-story traceability.*
      </template>

      <action>Determine labels based on story_key pattern:
        - Extract epic number from story_key (e.g., "1-3-farmer-registration" -> epic-1)
        - Always add "story" label
        - Add "epic-{{epic_number}}" label
      </action>
    </step>

    <step n="5" title="Create GitHub Issue">
      <action>Use mcp__github__create_issue with:
        - owner: {{github_owner}}
        - repo: {{github_repo}}
        - title: {{issue_title}}
        - body: {{issue_body}}
        - labels: ["story", "epic-{{epic_number}}"]
      </action>
      <action>Store returned issue number as {{new_issue_number}}</action>
      <action>Display success message with issue URL</action>
    </step>

    <step n="6" title="Update Story File">
      <action>Read current story file content</action>
      <action>Find the "**Status:**" line in the frontmatter section</action>
      <action>Add "**GitHub Issue:** #{{new_issue_number}}" line after Status line</action>
      <action>Write updated content back to story file</action>
      <action>Display confirmation of story file update</action>
    </step>

    <step n="7" title="Update Sprint Status (if exists)">
      <check if="sprint-status.yaml exists">
        <action>Read sprint-status.yaml</action>
        <action>Find the story entry matching story_key</action>
        <action>Add github_issue field with issue number</action>
        <action>Write updated sprint-status.yaml</action>
      </check>
    </step>

    <step n="8" title="Summary">
      <output>
## GitHub Issue Created Successfully

**Issue:** #{{new_issue_number}}
**URL:** https://github.com/{{github_owner}}/{{github_repo}}/issues/{{new_issue_number}}
**Story:** {{story_key}}

### Commit Message Format

‚ö†Ô∏è **IMPORTANT:** Put issue reference in the SUBJECT LINE for reliable GitHub linking!

**Subject line format:**
```
{{story_key}}: {{short_description}} (Relates to #{{new_issue_number}})
```

**Example:**
```
1-5: Farmer Communication Preferences (Relates to #{{new_issue_number}})

Detailed description of changes...

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
```

‚ö†Ô∏è Do NOT use "Fixes #N" or "Closes #N" until story reaches "done" status - these auto-close the issue!
      </output>
    </step>
  </flow>

  <halt-conditions critical="true">
    <i>HALT if no story file can be found or accessed</i>
    <i>HALT if git remote cannot be determined</i>
    <i>HALT if GitHub issue creation fails (API error)</i>
    <i>HALT if story already has a valid GitHub issue linked</i>
  </halt-conditions>

  <validation>
    <i>Verify story file exists and is readable</i>
    <i>Verify GitHub credentials are configured (MCP server available)</i>
    <i>Verify repository owner and name are correctly extracted</i>
    <i>Verify issue was created successfully before updating story file</i>
  </validation>
</task>
