# E2E Testing Infrastructure - Docker Compose
# Usage: docker-compose -f tests/e2e/infrastructure/docker-compose.e2e.yaml up -d
#
# This stack deploys:
# - Infrastructure: MongoDB, Redis, Azurite
# - Services: Plantation Model, Collection Model (with DAPR sidecars)
# - MCP Servers: Plantation MCP, Collection MCP (both with DAPR sidecars)
# - Mock servers: Google Elevation API
#
# All services use E2E-specific databases that are cleaned after tests.

services:
  # ==========================================================================
  # Infrastructure Services
  # ==========================================================================

  mongodb:
    image: mongo:7.0
    container_name: e2e-mongodb
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: farmer_power_e2e
    volumes:
      - e2e_mongodb_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    networks:
      - e2e-network

  redis:
    image: redis:7-alpine
    container_name: e2e-redis
    ports:
      - "6380:6379"  # Use 6380 to avoid conflict with local redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - e2e-network

  azurite:
    image: mcr.microsoft.com/azure-storage/azurite:3.29.0
    container_name: e2e-azurite
    ports:
      - "10000:10000"  # Blob service
      - "10001:10001"  # Queue service
      - "10002:10002"  # Table service
    command: "azurite --blobHost 0.0.0.0 --queueHost 0.0.0.0 --tableHost 0.0.0.0 --loose --skipApiVersionCheck"
    healthcheck:
      # Use node (available in Azurite image) instead of nc (not available)
      test: ["CMD-SHELL", "node -e \"const http = require('http'); http.get('http://localhost:10000/', (r) => process.exit(0)).on('error', () => process.exit(1))\""]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    networks:
      - e2e-network

  # ==========================================================================
  # Mock Servers
  # ==========================================================================

  google-elevation-mock:
    build:
      context: ./mock-servers/google-elevation
      dockerfile: Dockerfile
    container_name: e2e-google-elevation-mock
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    networks:
      - e2e-network

  # ==========================================================================
  # Plantation Model Service + DAPR Sidecar
  # ==========================================================================

  plantation-model:
    build:
      context: ../../..
      dockerfile: services/plantation-model/Dockerfile
    container_name: e2e-plantation-model
    ports:
      - "8001:8000"
      - "50051:50051"
    environment:
      PLANTATION_MONGODB_URI: mongodb://mongodb:27017
      PLANTATION_MONGODB_DATABASE: plantation_e2e
      PLANTATION_COLLECTION_MONGODB_URI: mongodb://mongodb:27017
      PLANTATION_COLLECTION_MONGODB_DATABASE: collection_e2e
      PLANTATION_LOG_LEVEL: DEBUG
      PLANTATION_OTEL_ENABLED: "false"
      PLANTATION_GOOGLE_ELEVATION_API_KEY: mock
      PLANTATION_GOOGLE_ELEVATION_API_URL: http://google-elevation-mock:8080
      PLANTATION_DAPR_HOST: localhost
      PLANTATION_DAPR_HTTP_PORT: "3500"
    depends_on:
      mongodb:
        condition: service_healthy
      google-elevation-mock:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 15s
    networks:
      - e2e-network

  plantation-model-dapr:
    image: daprio/daprd:1.12.0
    container_name: e2e-plantation-model-dapr
    command: [
      "./daprd",
      "-app-id", "plantation-model",
      "-app-port", "50051",
      "-app-protocol", "grpc",
      "-dapr-http-port", "3500",
      "-dapr-grpc-port", "50001",
      "-components-path", "/components"
    ]
    volumes:
      - ./dapr-components:/components
    network_mode: "service:plantation-model"
    depends_on:
      plantation-model:
        condition: service_started
      redis:
        condition: service_healthy

  # ==========================================================================
  # Collection Model Service + DAPR Sidecar
  # ==========================================================================

  collection-model:
    build:
      context: ../../..
      dockerfile: services/collection-model/Dockerfile
    container_name: e2e-collection-model
    ports:
      - "8002:8000"
    environment:
      COLLECTION_MONGODB_URI: mongodb://mongodb:27017
      COLLECTION_MONGODB_DATABASE: collection_e2e
      COLLECTION_LOG_LEVEL: DEBUG
      COLLECTION_OTEL_ENABLED: "false"
      COLLECTION_AZURE_STORAGE_CONNECTION_STRING: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1"
      COLLECTION_DAPR_HOST: localhost
      COLLECTION_DAPR_HTTP_PORT: "3500"
    depends_on:
      mongodb:
        condition: service_healthy
      azurite:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 15s
    networks:
      - e2e-network

  collection-model-dapr:
    image: daprio/daprd:1.12.0
    container_name: e2e-collection-model-dapr
    command: [
      "./daprd",
      "-app-id", "collection-model",
      "-app-port", "8000",
      "-dapr-http-port", "3500",
      "-dapr-grpc-port", "50001",
      "-components-path", "/components"
    ]
    volumes:
      - ./dapr-components:/components
    network_mode: "service:collection-model"
    depends_on:
      collection-model:
        condition: service_started
      redis:
        condition: service_healthy

  # ==========================================================================
  # Plantation MCP Server + DAPR Sidecar
  # Plantation MCP calls Plantation Model via DAPR gRPC service invocation
  # ==========================================================================

  plantation-mcp:
    build:
      context: ../../..
      dockerfile: mcp-servers/plantation-mcp/Dockerfile
    container_name: e2e-plantation-mcp
    ports:
      - "50052:50051"
    environment:
      PLANTATION_MCP_GRPC_PORT: "50051"
      PLANTATION_MCP_PLANTATION_APP_ID: plantation-model
      PLANTATION_MCP_LOG_LEVEL: DEBUG
    depends_on:
      plantation-model:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import grpc; channel = grpc.insecure_channel('localhost:50051'); grpc.channel_ready_future(channel).result(timeout=5)"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 10s
    networks:
      - e2e-network

  plantation-mcp-dapr:
    image: daprio/daprd:1.12.0
    container_name: e2e-plantation-mcp-dapr
    command: [
      "./daprd",
      "-app-id", "plantation-mcp",
      "-app-port", "50051",
      "-app-protocol", "grpc",
      "-dapr-http-port", "3500",
      "-dapr-grpc-port", "50001",
      "-components-path", "/components"
    ]
    volumes:
      - ./dapr-components:/components
    network_mode: "service:plantation-mcp"
    depends_on:
      plantation-mcp:
        condition: service_started
      redis:
        condition: service_healthy

  # ==========================================================================
  # Collection MCP Server + DAPR Sidecar
  # Exposed via DAPR for AI-Model calls, reads directly from MongoDB
  # ==========================================================================

  collection-mcp:
    build:
      context: ../../..
      dockerfile: mcp-servers/collection-mcp/Dockerfile
    container_name: e2e-collection-mcp
    ports:
      - "50053:50051"
    environment:
      COLLECTION_MCP_GRPC_PORT: "50051"
      COLLECTION_MCP_MONGODB_URI: mongodb://mongodb:27017
      COLLECTION_MCP_MONGODB_DATABASE: collection_e2e
      COLLECTION_MCP_AZURE_STORAGE_CONNECTION_STRING: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1"
      COLLECTION_MCP_LOG_LEVEL: DEBUG
    depends_on:
      mongodb:
        condition: service_healthy
      azurite:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import grpc; channel = grpc.insecure_channel('localhost:50051'); grpc.channel_ready_future(channel).result(timeout=5)"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 10s
    networks:
      - e2e-network

  collection-mcp-dapr:
    image: daprio/daprd:1.12.0
    container_name: e2e-collection-mcp-dapr
    command: [
      "./daprd",
      "-app-id", "collection-mcp",
      "-app-port", "50051",
      "-app-protocol", "grpc",
      "-dapr-http-port", "3500",
      "-dapr-grpc-port", "50001",
      "-components-path", "/components"
    ]
    volumes:
      - ./dapr-components:/components
    network_mode: "service:collection-mcp"
    depends_on:
      collection-mcp:
        condition: service_started
      redis:
        condition: service_healthy

volumes:
  e2e_mongodb_data:
    driver: local

networks:
  e2e-network:
    driver: bridge
