# E2E Testing Infrastructure - Docker Compose
# Usage: docker-compose -f tests/e2e/infrastructure/docker-compose.e2e.yaml up -d
#
# This stack deploys:
# - Infrastructure: MongoDB, Redis, Azurite
# - Services: Plantation Model, Collection Model, BFF (with DAPR sidecars)
# - MCP Servers: Plantation MCP, Collection MCP (both with DAPR sidecars)
# - Mock servers: Google Elevation API, Mock AI Model
#
# All services use E2E-specific databases that are cleaned after tests.

services:
  # ==========================================================================
  # Infrastructure Services
  # ==========================================================================

  mongodb:
    image: mongo:7.0
    container_name: e2e-mongodb
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: farmer_power_e2e
    volumes:
      - e2e_mongodb_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    networks:
      - e2e-network

  redis:
    image: redis:7-alpine
    container_name: e2e-redis
    ports:
      - "6380:6379"  # Use 6380 to avoid conflict with local redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - e2e-network

  azurite:
    image: mcr.microsoft.com/azure-storage/azurite:3.29.0
    container_name: e2e-azurite
    ports:
      - "10000:10000"  # Blob service
      - "10001:10001"  # Queue service
      - "10002:10002"  # Table service
    command: "azurite --blobHost 0.0.0.0 --queueHost 0.0.0.0 --tableHost 0.0.0.0 --loose --skipApiVersionCheck"
    healthcheck:
      # Use node (available in Azurite image) instead of nc (not available)
      test: ["CMD-SHELL", "node -e \"const http = require('http'); http.get('http://localhost:10000/', (r) => process.exit(0)).on('error', () => process.exit(1))\""]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    networks:
      - e2e-network

  # ==========================================================================
  # Mock Servers
  # ==========================================================================

  google-elevation-mock:
    build:
      context: ./mock-servers/google-elevation
      dockerfile: Dockerfile
    container_name: e2e-google-elevation-mock
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    networks:
      - e2e-network

  # ==========================================================================
  # Mock AI Model gRPC Server + DAPR Sidecar
  # Used by Collection Model for AI-based extraction (Story 0.4.6)
  # ==========================================================================

  mock-ai-model:
    build:
      context: ../../..
      dockerfile: tests/e2e/infrastructure/mock-servers/ai-model/Dockerfile
    container_name: e2e-mock-ai-model
    ports:
      - "8090:50051"
    healthcheck:
      test: ["CMD", "python", "-c", "import grpc; channel = grpc.insecure_channel('localhost:50051'); grpc.channel_ready_future(channel).result(timeout=5)"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    networks:
      - e2e-network

  mock-ai-model-dapr:
    image: daprio/daprd:1.14.0
    container_name: e2e-mock-ai-model-dapr
    command: [
      "./daprd",
      "-app-id", "ai-model",
      "-app-port", "50051",
      "-app-protocol", "grpc",
      "-dapr-http-port", "3500",
      "-dapr-grpc-port", "50001",
      "-components-path", "/components"
    ]
    volumes:
      - ./dapr-components:/components
    network_mode: "service:mock-ai-model"
    depends_on:
      mock-ai-model:
        condition: service_started
      redis:
        condition: service_healthy

  # ==========================================================================
  # Plantation Model Service + DAPR Sidecar
  # ==========================================================================

  plantation-model:
    build:
      context: ../../..
      dockerfile: services/plantation-model/Dockerfile
    container_name: e2e-plantation-model
    ports:
      - "8001:8000"
      - "50051:50051"
    environment:
      PLANTATION_MONGODB_URI: mongodb://mongodb:27017
      PLANTATION_MONGODB_DATABASE: plantation_e2e
      # Story 0.6.13: Use gRPC instead of direct MongoDB access
      # Direct gRPC connection to Collection Model (bypasses DAPR service invocation)
      PLANTATION_COLLECTION_APP_ID: collection-model
      PLANTATION_COLLECTION_GRPC_HOST: "collection-model:50051"
      PLANTATION_LOG_LEVEL: DEBUG
      PLANTATION_OTEL_ENABLED: "false"
      PLANTATION_GOOGLE_ELEVATION_API_KEY: mock
      PLANTATION_GOOGLE_ELEVATION_API_URL: http://google-elevation-mock:8080
      PLANTATION_DAPR_HOST: localhost
      PLANTATION_DAPR_HTTP_PORT: "3500"
    depends_on:
      mongodb:
        condition: service_healthy
      google-elevation-mock:
        condition: service_healthy
      collection-model:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 15s
    networks:
      - e2e-network

  plantation-model-dapr:
    image: daprio/daprd:1.14.0
    container_name: e2e-plantation-model-dapr
    # ADR-010/ADR-011: gRPC service invocation + streaming pub/sub
    # - app-port 50051: gRPC service API (PlantationService)
    # - app-protocol grpc: For service invocation via DAPR proxy
    # - Pub/sub uses streaming subscriptions (outbound from app, no extra port)
    command: [
      "./daprd",
      "-app-id", "plantation-model",
      "-app-port", "50051",
      "-app-protocol", "grpc",
      "-dapr-http-port", "3500",
      "-dapr-grpc-port", "50001",
      "-components-path", "/components"
    ]
    volumes:
      - ./dapr-components:/components
    network_mode: "service:plantation-model"
    depends_on:
      plantation-model:
        condition: service_started
      redis:
        condition: service_healthy

  # ==========================================================================
  # Collection Model Service + DAPR Sidecar
  # ==========================================================================

  collection-model:
    build:
      context: ../../..
      dockerfile: services/collection-model/Dockerfile
    container_name: e2e-collection-model
    ports:
      - "8002:8000"
      - "50054:50051"  # gRPC service port (Story 0.5.1a)
      - "3502:3500"  # DAPR HTTP port for E2E test pub/sub (Story 0.6.6)
    environment:
      COLLECTION_MONGODB_URI: mongodb://mongodb:27017
      COLLECTION_MONGODB_DATABASE: collection_e2e
      COLLECTION_LOG_LEVEL: DEBUG
      COLLECTION_OTEL_ENABLED: "false"
      COLLECTION_AZURE_STORAGE_CONNECTION_STRING: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1"
      COLLECTION_DAPR_HOST: localhost
      COLLECTION_DAPR_HTTP_PORT: "3500"
      COLLECTION_AI_MODEL_APP_ID: ai-model
    depends_on:
      mongodb:
        condition: service_healthy
      azurite:
        condition: service_healthy
      mock-ai-model:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 15s
    networks:
      - e2e-network

  collection-model-dapr:
    image: daprio/daprd:1.14.0
    container_name: e2e-collection-model-dapr
    # ADR-010/ADR-011: HTTP app protocol (FastAPI on 8000) + streaming pub/sub
    # - app-port 8000: FastAPI for health probes and job triggers
    # - Pub/sub uses streaming subscriptions (outbound from app, no extra port)
    command: [
      "./daprd",
      "-app-id", "collection-model",
      "-app-port", "8000",
      "-dapr-http-port", "3500",
      "-dapr-grpc-port", "50001",
      "-components-path", "/components"
    ]
    volumes:
      - ./dapr-components:/components
    network_mode: "service:collection-model"
    depends_on:
      collection-model:
        condition: service_started
      redis:
        condition: service_healthy

  # ==========================================================================
  # Plantation MCP Server + DAPR Sidecar
  # Plantation MCP calls Plantation Model via direct gRPC (not DAPR service invocation)
  # Note: DAPR sidecar is kept for potential future use but not used for service calls
  # ==========================================================================

  plantation-mcp:
    build:
      context: ../../..
      dockerfile: mcp-servers/plantation-mcp/Dockerfile
    container_name: e2e-plantation-mcp
    ports:
      - "50052:50051"
    environment:
      PLANTATION_MCP_GRPC_PORT: "50051"
      PLANTATION_MCP_PLANTATION_APP_ID: plantation-model
      # Direct gRPC connection to Plantation Model (bypasses DAPR service invocation)
      # Required because DAPR sidecar is configured for HTTP (pub/sub) not gRPC
      PLANTATION_MCP_PLANTATION_GRPC_HOST: "plantation-model:50051"
      PLANTATION_MCP_LOG_LEVEL: DEBUG
    depends_on:
      plantation-model:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import grpc; channel = grpc.insecure_channel('localhost:50051'); grpc.channel_ready_future(channel).result(timeout=5)"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 10s
    networks:
      - e2e-network

  plantation-mcp-dapr:
    image: daprio/daprd:1.14.0
    container_name: e2e-plantation-mcp-dapr
    command: [
      "./daprd",
      "-app-id", "plantation-mcp",
      "-app-port", "50051",
      "-app-protocol", "grpc",
      "-dapr-http-port", "3500",
      "-dapr-grpc-port", "50001",
      "-components-path", "/components"
    ]
    volumes:
      - ./dapr-components:/components
    network_mode: "service:plantation-mcp"
    depends_on:
      plantation-mcp:
        condition: service_started
      redis:
        condition: service_healthy

  # ==========================================================================
  # Collection MCP Server + DAPR Sidecar
  # Exposed via DAPR for AI-Model calls, reads directly from MongoDB
  # ==========================================================================

  collection-mcp:
    build:
      context: ../../..
      dockerfile: mcp-servers/collection-mcp/Dockerfile
    container_name: e2e-collection-mcp
    ports:
      - "50053:50051"
    environment:
      COLLECTION_MCP_GRPC_PORT: "50051"
      COLLECTION_MCP_MONGODB_URI: mongodb://mongodb:27017
      COLLECTION_MCP_MONGODB_DATABASE: collection_e2e
      COLLECTION_MCP_AZURE_STORAGE_CONNECTION_STRING: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1"
      COLLECTION_MCP_LOG_LEVEL: DEBUG
    depends_on:
      mongodb:
        condition: service_healthy
      azurite:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import grpc; channel = grpc.insecure_channel('localhost:50051'); grpc.channel_ready_future(channel).result(timeout=5)"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 10s
    networks:
      - e2e-network

  collection-mcp-dapr:
    image: daprio/daprd:1.14.0
    container_name: e2e-collection-mcp-dapr
    command: [
      "./daprd",
      "-app-id", "collection-mcp",
      "-app-port", "50051",
      "-app-protocol", "grpc",
      "-dapr-http-port", "3500",
      "-dapr-grpc-port", "50001",
      "-components-path", "/components"
    ]
    volumes:
      - ./dapr-components:/components
    network_mode: "service:collection-mcp"
    depends_on:
      collection-mcp:
        condition: service_started
      redis:
        condition: service_healthy

  # ==========================================================================
  # BFF Service + DAPR Sidecar (Story 0.5.2)
  # Backend for Frontend - REST API gateway for React frontends
  # ==========================================================================

  bff:
    build:
      context: ../../..
      dockerfile: services/bff/Dockerfile
    container_name: e2e-bff
    ports:
      - "8083:8080"  # BFF REST API
    environment:
      APP_ENV: test
      AUTH_PROVIDER: mock
      MOCK_JWT_SECRET: test-secret-for-e2e
      DAPR_HTTP_PORT: "3500"
      DAPR_GRPC_PORT: "50001"
      # Direct gRPC connection to Plantation Model (bypasses DAPR service invocation)
      # Required because DAPR mDNS discovery doesn't work across Docker network namespaces
      PLANTATION_GRPC_HOST: "plantation-model:50051"
      OTEL_ENABLED: "false"
      LOG_LEVEL: DEBUG
    depends_on:
      plantation-model:
        condition: service_healthy
      collection-model:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 15s
    networks:
      - e2e-network

  bff-dapr:
    image: daprio/daprd:1.14.0
    container_name: e2e-bff-dapr
    # ADR-002: BFF uses HTTP protocol for REST API
    # - app-port 8080: FastAPI REST endpoints
    # - DAPR proxies gRPC calls to plantation-model and collection-model
    command: [
      "./daprd",
      "-app-id", "bff",
      "-app-port", "8080",
      "-dapr-http-port", "3500",
      "-dapr-grpc-port", "50001",
      "-components-path", "/components",
      "-config", "/config/config.yaml"
    ]
    volumes:
      - ./dapr-components:/components
      - ../../../services/bff/dapr:/config
    network_mode: "service:bff"
    depends_on:
      bff:
        condition: service_started
      redis:
        condition: service_healthy

volumes:
  e2e_mongodb_data:
    driver: local

networks:
  e2e-network:
    driver: bridge
