// Collection Model Service - Protocol Buffer Definitions
// Quality data ingestion gateway for the Farmer Power Platform
//
// Provides gRPC API for document queries via BFF (Story 0.5.1a).
// Uses HTTP/REST (FastAPI) for external endpoints and DAPR pub/sub for domain events.

syntax = "proto3";

package farmer_power.collection.v1;

import "google/protobuf/timestamp.proto";

// Note: Health checking uses standard grpc.health.v1.Health (grpc-health-checking package)
// No custom HealthService defined here to avoid duplication.

// ============================================================================
// Collection Service - gRPC API for document queries (Story 0.5.1a)
// ============================================================================

service CollectionService {
  // Get a single document by ID
  rpc GetDocument(GetDocumentRequest) returns (Document);

  // List documents with pagination and optional farmer_id filter
  rpc ListDocuments(ListDocumentsRequest) returns (ListDocumentsResponse);

  // Get all documents for a specific farmer (convenience method)
  rpc GetDocumentsByFarmer(GetDocumentsByFarmerRequest) returns (GetDocumentsByFarmerResponse);

  // Search documents with filters (source_id, date range, linkage fields)
  rpc SearchDocuments(SearchDocumentsRequest) returns (SearchDocumentsResponse);
}

// ============================================================================
// Source Config Service - Read-only admin visibility (ADR-019, Story 9.11a)
// Write operations handled by source-config CLI
// ============================================================================

service SourceConfigService {
  // List all source configurations with optional filters
  rpc ListSourceConfigs(ListSourceConfigsRequest) returns (ListSourceConfigsResponse);

  // Get a single source configuration by ID
  rpc GetSourceConfig(GetSourceConfigRequest) returns (SourceConfigResponse);
}

message ListSourceConfigsRequest {
  int32 page_size = 1;         // Max 100, default 20
  string page_token = 2;       // Pagination cursor
  bool enabled_only = 3;       // Filter to enabled configs only
  string ingestion_mode = 4;   // Filter: "blob_trigger" or "scheduled_pull"
}

message ListSourceConfigsResponse {
  repeated SourceConfigSummary configs = 1;
  string next_page_token = 2;
  int32 total_count = 3;
}

message GetSourceConfigRequest {
  string source_id = 1;
}

message SourceConfigSummary {
  string source_id = 1;
  string display_name = 2;
  string description = 3;
  bool enabled = 4;
  string ingestion_mode = 5;      // "blob_trigger" or "scheduled_pull"
  string ai_agent_id = 6;         // Linked AI agent (nullable)
  google.protobuf.Timestamp updated_at = 7;
}

message SourceConfigResponse {
  string source_id = 1;
  string display_name = 2;
  string description = 3;
  bool enabled = 4;

  // Full config as JSON for detail view
  // Using JSON string to avoid duplicating complex nested proto definitions
  string config_json = 5;

  google.protobuf.Timestamp created_at = 6;
  google.protobuf.Timestamp updated_at = 7;
}

// ============================================================================
// Document Messages (Story 0.5.1a)
// ============================================================================

// Reference to raw document in blob storage
message RawDocumentRef {
  string blob_container = 1;
  string blob_path = 2;
  string content_hash = 3;
  int64 size_bytes = 4;
  google.protobuf.Timestamp stored_at = 5;
}

// Metadata about AI extraction
message ExtractionMetadata {
  string ai_agent_id = 1;
  google.protobuf.Timestamp extraction_timestamp = 2;
  double confidence = 3;
  bool validation_passed = 4;
  repeated string validation_warnings = 5;
}

// Metadata about ingestion process
message IngestionMetadata {
  string ingestion_id = 1;
  string source_id = 2;
  google.protobuf.Timestamp received_at = 3;
  google.protobuf.Timestamp processed_at = 4;
}

// Document entity returned by gRPC methods
message Document {
  string document_id = 1;
  RawDocumentRef raw_document = 2;
  ExtractionMetadata extraction = 3;
  IngestionMetadata ingestion = 4;
  map<string, string> extracted_fields = 5;  // Stored as string map for proto compatibility
  map<string, string> linkage_fields = 6;    // Dynamic fields for indexing
  google.protobuf.Timestamp created_at = 7;
}

// ============================================================================
// Request/Response Messages (Story 0.5.1a)
// ============================================================================

message GetDocumentRequest {
  string document_id = 1;
  string collection_name = 2;  // Collection to search in (from source config)
}

message ListDocumentsRequest {
  int32 page_size = 1;         // Max 100, default 20
  string page_token = 2;       // Pagination cursor
  string farmer_id = 3;        // Optional filter by farmer_id
  string collection_name = 4;  // Collection to search in
}

message ListDocumentsResponse {
  repeated Document documents = 1;
  string next_page_token = 2;
  int32 total_count = 3;
}

message GetDocumentsByFarmerRequest {
  string farmer_id = 1;
  string collection_name = 2;
  int32 limit = 3;  // Max results, default 100
}

message GetDocumentsByFarmerResponse {
  repeated Document documents = 1;
  int32 total_count = 2;
}

message SearchDocumentsRequest {
  string collection_name = 1;
  string source_id = 2;                      // Filter by source configuration ID
  google.protobuf.Timestamp start_date = 3;  // Filter by created_at >= start_date
  google.protobuf.Timestamp end_date = 4;    // Filter by created_at <= end_date
  map<string, string> linkage_filters = 5;   // Filter by linkage_fields (e.g., farmer_id=WM-0001)
  int32 page_size = 6;
  string page_token = 7;
}

message SearchDocumentsResponse {
  repeated Document documents = 1;
  string next_page_token = 2;
  int32 total_count = 3;
}

// ============================================================================
// Domain Events (published via DAPR pub/sub)
// ============================================================================

// Event published when a document is stored
message DocumentStoredEvent {
  string document_id = 1;
  string source_type = 2;  // "qc_analyzer_result", "qc_analyzer_exception", etc.
  string farmer_id = 3;
  string blob_path = 4;
  string blob_etag = 5;
  string content_hash = 6;
  string content_type = 7;
  int64 content_length = 8;
  google.protobuf.Timestamp timestamp = 9;
}

// Event published when quality drops below threshold
message PoorQualityDetectedEvent {
  string event_id = 1;
  string farmer_id = 2;
  double primary_percentage = 3;
  double threshold = 4;
  map<string, double> leaf_type_distribution = 5;
  string priority = 6;  // "standard" or "critical"
  google.protobuf.Timestamp timestamp = 7;
}

// Event published when weather data is updated
message WeatherUpdatedEvent {
  string region_id = 1;
  string weather_date = 2;  // YYYY-MM-DD
  double temperature_high = 3;
  double temperature_low = 4;
  double rainfall_mm = 5;
  double humidity_percent = 6;
  google.protobuf.Timestamp timestamp = 7;
}

// Event published when market prices are updated
message MarketPricesUpdatedEvent {
  string commodity = 1;
  string region = 2;
  double price_per_kg = 3;
  string currency = 4;
  string price_date = 5;  // YYYY-MM-DD
  google.protobuf.Timestamp timestamp = 6;
}

// ============================================================================
// Common Types
// ============================================================================

// Event types published by Collection Model
enum EventType {
  EVENT_TYPE_UNSPECIFIED = 0;
  EVENT_TYPE_DOCUMENT_STORED = 1;
  EVENT_TYPE_POOR_QUALITY_DETECTED = 2;
  EVENT_TYPE_WEATHER_UPDATED = 3;
  EVENT_TYPE_MARKET_PRICES_UPDATED = 4;
}

// Quality grade from TBK grading
enum QualityGrade {
  QUALITY_GRADE_UNSPECIFIED = 0;
  QUALITY_GRADE_PRIMARY = 1;
  QUALITY_GRADE_SECONDARY = 2;
}

// ============================================================================
// Event Messages (for future MCP server use)
// ============================================================================

// Base event metadata
message EventMetadata {
  string event_id = 1;
  string farmer_id = 2;
  string collection_point_id = 3;
  google.protobuf.Timestamp timestamp = 4;
  string source = 5;  // "qc_analyzer", "factory_pos", "mobile_app"
}

// End bag event from QC Analyzer (Story 2-4)
message EndBagEvent {
  EventMetadata metadata = 1;
  double weight_kg = 2;
  QualityGrade quality_grade = 3;
  map<string, string> attributes = 4;  // TBK attribute values
  string bag_id = 5;
}

// ============================================================================
// Query Messages (for future MCP server use)
// ============================================================================

message GetQualityEventsRequest {
  string farmer_id = 1;
  google.protobuf.Timestamp start_date = 2;
  google.protobuf.Timestamp end_date = 3;
  int32 page_size = 4;
  string page_token = 5;
}

message GetQualityEventsResponse {
  repeated EndBagEvent events = 1;
  string next_page_token = 2;
  int32 total_count = 3;
}
