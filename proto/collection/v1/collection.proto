// Collection Model Service - Protocol Buffer Definitions
// Quality data ingestion gateway for the Farmer Power Platform
//
// Note: Collection Model uses HTTP/REST (FastAPI) for external endpoints
// and DAPR pub/sub for domain events. These proto definitions are used
// for event serialization and MCP server interfaces.

syntax = "proto3";

package farmer_power.collection.v1;

import "google/protobuf/timestamp.proto";

// ============================================================================
// Domain Events (published via DAPR pub/sub)
// ============================================================================

// Event published when a document is stored
message DocumentStoredEvent {
  string document_id = 1;
  string source_type = 2;  // "qc_analyzer_result", "qc_analyzer_exception", etc.
  string farmer_id = 3;
  string blob_path = 4;
  string blob_etag = 5;
  string content_hash = 6;
  string content_type = 7;
  int64 content_length = 8;
  google.protobuf.Timestamp timestamp = 9;
}

// Event published when quality drops below threshold
message PoorQualityDetectedEvent {
  string event_id = 1;
  string farmer_id = 2;
  double primary_percentage = 3;
  double threshold = 4;
  map<string, double> leaf_type_distribution = 5;
  string priority = 6;  // "standard" or "critical"
  google.protobuf.Timestamp timestamp = 7;
}

// Event published when weather data is updated
message WeatherUpdatedEvent {
  string region_id = 1;
  string weather_date = 2;  // YYYY-MM-DD
  double temperature_high = 3;
  double temperature_low = 4;
  double rainfall_mm = 5;
  double humidity_percent = 6;
  google.protobuf.Timestamp timestamp = 7;
}

// Event published when market prices are updated
message MarketPricesUpdatedEvent {
  string commodity = 1;
  string region = 2;
  double price_per_kg = 3;
  string currency = 4;
  string price_date = 5;  // YYYY-MM-DD
  google.protobuf.Timestamp timestamp = 6;
}

// ============================================================================
// Common Types
// ============================================================================

// Event types published by Collection Model
enum EventType {
  EVENT_TYPE_UNSPECIFIED = 0;
  EVENT_TYPE_DOCUMENT_STORED = 1;
  EVENT_TYPE_POOR_QUALITY_DETECTED = 2;
  EVENT_TYPE_WEATHER_UPDATED = 3;
  EVENT_TYPE_MARKET_PRICES_UPDATED = 4;
}

// Quality grade from TBK grading
enum QualityGrade {
  QUALITY_GRADE_UNSPECIFIED = 0;
  QUALITY_GRADE_PRIMARY = 1;
  QUALITY_GRADE_SECONDARY = 2;
}

// ============================================================================
// Event Messages (for future MCP server use)
// ============================================================================

// Base event metadata
message EventMetadata {
  string event_id = 1;
  string farmer_id = 2;
  string collection_point_id = 3;
  google.protobuf.Timestamp timestamp = 4;
  string source = 5;  // "qc_analyzer", "factory_pos", "mobile_app"
}

// End bag event from QC Analyzer (Story 2-4)
message EndBagEvent {
  EventMetadata metadata = 1;
  double weight_kg = 2;
  QualityGrade quality_grade = 3;
  map<string, string> attributes = 4;  // TBK attribute values
  string bag_id = 5;
}

// ============================================================================
// Query Messages (for future MCP server use)
// ============================================================================

message GetQualityEventsRequest {
  string farmer_id = 1;
  google.protobuf.Timestamp start_date = 2;
  google.protobuf.Timestamp end_date = 3;
  int32 page_size = 4;
  string page_token = 5;
}

message GetQualityEventsResponse {
  repeated EndBagEvent events = 1;
  string next_page_token = 2;
  int32 total_count = 3;
}
