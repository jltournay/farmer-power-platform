// AI Model Service - gRPC API Definition
// LLM extraction gateway for all domain models
// Story 0.75.5: Added CostService for LLM cost observability

syntax = "proto3";

package farmer_power.ai_model.v1;

import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";

// AiModelService provides LLM-based extraction capabilities
service AiModelService {
  // Extract structured data from raw content using LLM
  rpc Extract(ExtractionRequest) returns (ExtractionResponse);

  // Health check for service readiness
  rpc HealthCheck(HealthCheckRequest) returns (HealthCheckResponse);
}

// CostService provides LLM cost observability (Story 0.75.5)
// Consumed by Epic 9 (Platform Admin Dashboard) for cost monitoring
service CostService {
  // Get daily cost summaries for a date range
  rpc GetDailyCostSummary(DateRangeRequest) returns (DailyCostSummaryResponse);

  // Get current day's running cost total
  rpc GetCurrentDayCost(google.protobuf.Empty) returns (CostSummaryResponse);

  // Get cost breakdown by agent type
  rpc GetCostByAgentType(DateRangeRequest) returns (CostByAgentTypeResponse);

  // Get cost breakdown by model
  rpc GetCostByModel(DateRangeRequest) returns (CostByModelResponse);

  // Get active cost alerts
  rpc GetCostAlerts(google.protobuf.Empty) returns (CostAlertsResponse);

  // Configure cost thresholds at runtime
  rpc ConfigureCostThreshold(ThresholdConfigRequest) returns (google.protobuf.Empty);
}

// ============================================
// Extraction Service Messages
// ============================================

message ExtractionRequest {
  // Raw content to extract from (JSON, text, etc.)
  string raw_content = 1;

  // AI agent ID from source configuration (e.g., "qc-exception-extraction-agent")
  string ai_agent_id = 2;

  // Source configuration hints for extraction
  string source_config_json = 3;

  // MIME type of the content
  string content_type = 4;

  // OpenTelemetry trace ID for distributed tracing
  string trace_id = 5;
}

message ExtractionResponse {
  // Whether extraction succeeded
  bool success = 1;

  // Extracted fields as JSON
  string extracted_fields_json = 2;

  // Confidence score of the extraction (0.0-1.0)
  float confidence = 3;

  // Whether extraction passed semantic validation
  bool validation_passed = 4;

  // Validation warnings (non-blocking issues)
  repeated string validation_warnings = 5;

  // Error message if success=false
  string error_message = 6;
}

message HealthCheckRequest {}

message HealthCheckResponse {
  bool healthy = 1;
  string version = 2;
}

// ============================================
// Cost Service Messages (Story 0.75.5)
// ============================================

message DateRangeRequest {
  google.protobuf.Timestamp start_date = 1;
  google.protobuf.Timestamp end_date = 2;
}

message CostSummaryResponse {
  // Total cost in USD (string for Decimal precision)
  string total_cost_usd = 1;
  int64 total_requests = 2;
  int64 total_tokens_in = 3;
  int64 total_tokens_out = 4;
}

message DailyCost {
  google.protobuf.Timestamp date = 1;
  string total_cost_usd = 2;
  int64 total_requests = 3;
  int64 total_tokens_in = 4;
  int64 total_tokens_out = 5;
  int64 success_count = 6;
  int64 failure_count = 7;
}

message DailyCostSummaryResponse {
  repeated DailyCost daily_costs = 1;
}

message AgentTypeCostEntry {
  string agent_type = 1;
  string total_cost_usd = 2;
  int64 total_requests = 3;
  int64 total_tokens = 4;
}

message CostByAgentTypeResponse {
  repeated AgentTypeCostEntry agent_type_costs = 1;
}

message ModelCostEntry {
  string model = 1;
  string total_cost_usd = 2;
  int64 total_requests = 3;
  int64 total_tokens = 4;
}

message CostByModelResponse {
  repeated ModelCostEntry model_costs = 1;
}

message CostAlert {
  // Type of threshold: "daily" or "monthly"
  string threshold_type = 1;
  // Configured threshold in USD
  string threshold_usd = 2;
  // Current cost when alert was triggered
  string current_cost_usd = 3;
  // When the alert was triggered
  google.protobuf.Timestamp triggered_at = 4;
  // ID of the cost event that triggered the alert
  string event_id = 5;
}

message CostAlertsResponse {
  repeated CostAlert alerts = 1;
  // Current budget status
  string daily_threshold_usd = 2;
  string daily_total_usd = 3;
  bool daily_alert_triggered = 4;
  string monthly_threshold_usd = 5;
  string monthly_total_usd = 6;
  bool monthly_alert_triggered = 7;
}

message ThresholdConfigRequest {
  // New daily threshold in USD (0 = disabled, -1 = no change)
  double daily_threshold_usd = 1;
  // New monthly threshold in USD (0 = disabled, -1 = no change)
  double monthly_threshold_usd = 2;
}

// ============================================
// RAG Document Service (Story 0.75.10)
// Manages RAG knowledge documents with versioning
// ============================================

// RAGDocumentService provides RAG document management capabilities
service RAGDocumentService {
  // CRUD Operations
  rpc CreateDocument(CreateDocumentRequest) returns (CreateDocumentResponse);
  rpc GetDocument(GetDocumentRequest) returns (RAGDocument);
  rpc UpdateDocument(UpdateDocumentRequest) returns (RAGDocument);
  rpc DeleteDocument(DeleteDocumentRequest) returns (DeleteDocumentResponse);

  // List & Search
  rpc ListDocuments(ListDocumentsRequest) returns (ListDocumentsResponse);
  rpc SearchDocuments(SearchDocumentsRequest) returns (SearchDocumentsResponse);

  // Lifecycle Management
  rpc StageDocument(StageDocumentRequest) returns (RAGDocument);
  rpc ActivateDocument(ActivateDocumentRequest) returns (RAGDocument);
  rpc ArchiveDocument(ArchiveDocumentRequest) returns (RAGDocument);
  rpc RollbackDocument(RollbackDocumentRequest) returns (RAGDocument);

  // Extraction Operations (Story 0.75.10b)
  rpc ExtractDocument(ExtractDocumentRequest) returns (ExtractDocumentResponse);
  rpc GetExtractionJob(GetExtractionJobRequest) returns (ExtractionJobResponse);
  rpc StreamExtractionProgress(StreamExtractionProgressRequest) returns (stream ExtractionProgressEvent);
}

// ============================================
// RAG Document Messages
// ============================================

// RAG knowledge document for expert knowledge storage
// Documents are versioned via document_id + version combination
message RAGDocument {
  // Unique document ID (format: {document_id}:v{version}) - MongoDB _id mapping
  string id = 1;
  // Stable ID across versions (e.g., "disease-diagnosis-guide")
  string document_id = 2;
  // Incrementing version number
  int32 version = 3;
  // Document title for display
  string title = 4;
  // Knowledge domain: plant_diseases, tea_cultivation, weather_patterns, quality_standards, regional_context
  string domain = 5;
  // Extracted/authored markdown text content
  string content = 6;
  // Document lifecycle status: draft, staged, active, archived
  string status = 7;
  // Document metadata
  RAGDocumentMetadata metadata = 8;
  // Original file reference if uploaded as PDF/DOCX
  SourceFile source_file = 9;
  // What changed from previous version
  string change_summary = 10;
  // Creation timestamp
  google.protobuf.Timestamp created_at = 11;
  // Last update timestamp
  google.protobuf.Timestamp updated_at = 12;
  // Pinecone namespace (e.g., "knowledge-v12")
  string pinecone_namespace = 13;
  // Vector IDs in Pinecone after vectorization
  repeated string pinecone_ids = 14;
  // SHA256 hash for change detection
  string content_hash = 15;
}

// Metadata for RAG document
message RAGDocumentMetadata {
  // Agronomist who created/updated the document
  string author = 1;
  // Original source (book, research paper, etc.)
  string source = 2;
  // Geographic relevance (e.g., "Kenya", "Rwanda")
  string region = 3;
  // Seasonal relevance (e.g., "dry_season", "monsoon")
  string season = 4;
  // Searchable tags for filtering
  repeated string tags = 5;
}

// Original uploaded file reference for PDF/DOCX uploads
message SourceFile {
  // Original filename (e.g., "blister-blight-guide.pdf")
  string filename = 1;
  // File type: pdf, docx, md, txt
  string file_type = 2;
  // Azure Blob path to original file
  string blob_path = 3;
  // File size in bytes
  int64 file_size_bytes = 4;
  // Extraction method: manual, text_extraction, azure_doc_intel, vision_llm
  string extraction_method = 5;
  // Extraction quality score (0-1)
  float extraction_confidence = 6;
  // Number of pages in document
  int32 page_count = 7;
}

// ============================================
// CRUD Request/Response Messages
// ============================================

message CreateDocumentRequest {
  // Stable document ID (optional - auto-generated UUID if not provided)
  string document_id = 1;
  // Document title for display
  string title = 2;
  // Knowledge domain: plant_diseases, tea_cultivation, weather_patterns, quality_standards, regional_context
  string domain = 3;
  // Document content (markdown text)
  string content = 4;
  // Document metadata
  RAGDocumentMetadata metadata = 5;
  // Optional source file reference
  SourceFile source_file = 6;
}

message CreateDocumentResponse {
  // Created document
  RAGDocument document = 1;
}

message GetDocumentRequest {
  // Document ID to retrieve
  string document_id = 1;
  // Optional: specific version to retrieve (0 = active version)
  int32 version = 2;
}

message UpdateDocumentRequest {
  // Document ID to update
  string document_id = 1;
  // Updated title (empty = no change)
  string title = 2;
  // Updated content (empty = no change)
  string content = 3;
  // Updated metadata (null = no change)
  RAGDocumentMetadata metadata = 4;
  // Summary of what changed
  string change_summary = 5;
}

message DeleteDocumentRequest {
  // Document ID to delete (archives all versions)
  string document_id = 1;
}

message DeleteDocumentResponse {
  // Number of versions archived
  int32 versions_archived = 1;
}

// ============================================
// List & Search Request/Response Messages
// ============================================

message ListDocumentsRequest {
  // Page number (1-indexed, default 1)
  int32 page = 1;
  // Page size (default 20, max 100)
  int32 page_size = 2;
  // Filter by domain
  string domain = 3;
  // Filter by status
  string status = 4;
  // Filter by author
  string author = 5;
}

message ListDocumentsResponse {
  // Documents for this page
  repeated RAGDocument documents = 1;
  // Total count matching filters
  int32 total_count = 2;
  // Current page number
  int32 page = 3;
  // Page size used
  int32 page_size = 4;
}

message SearchDocumentsRequest {
  // Search query (searches title and content)
  string query = 1;
  // Filter by domain
  string domain = 2;
  // Filter by status
  string status = 3;
  // Max results to return (default 20, max 100)
  int32 limit = 4;
}

message SearchDocumentsResponse {
  // Matching documents
  repeated RAGDocument documents = 1;
}

// ============================================
// Lifecycle Request Messages
// ============================================

message StageDocumentRequest {
  // Document ID to stage
  string document_id = 1;
  // Version to stage (must be in draft status)
  int32 version = 2;
}

message ActivateDocumentRequest {
  // Document ID to activate
  string document_id = 1;
  // Version to activate (must be in staged status)
  int32 version = 2;
}

message ArchiveDocumentRequest {
  // Document ID to archive
  string document_id = 1;
  // Version to archive (optional - 0 archives all versions)
  int32 version = 2;
}

message RollbackDocumentRequest {
  // Document ID to rollback
  string document_id = 1;
  // Version to rollback to (creates new draft version with content from this version)
  int32 target_version = 2;
}

// ============================================
// Extraction Request/Response Messages (Story 0.75.10b)
// ============================================

message ExtractDocumentRequest {
  // Document ID to extract content from
  string document_id = 1;
  // Optional: specific version to extract (0 = latest version)
  int32 version = 2;
}

message ExtractDocumentResponse {
  // Job ID for tracking extraction progress
  string job_id = 1;
}

message GetExtractionJobRequest {
  // Job ID to retrieve status for
  string job_id = 1;
}

message ExtractionJobResponse {
  // Unique job identifier
  string job_id = 1;
  // RAG document being extracted
  string document_id = 2;
  // Job status: pending, in_progress, completed, failed
  string status = 3;
  // Extraction progress (0-100)
  int32 progress_percent = 4;
  // Number of pages extracted so far
  int32 pages_processed = 5;
  // Total pages in document (0 if unknown)
  int32 total_pages = 6;
  // Error details if status is failed
  string error_message = 7;
  // Job start timestamp
  google.protobuf.Timestamp started_at = 8;
  // Job completion timestamp (if completed or failed)
  google.protobuf.Timestamp completed_at = 9;
}

message StreamExtractionProgressRequest {
  // Job ID to stream progress for
  string job_id = 1;
}

message ExtractionProgressEvent {
  // Unique job identifier
  string job_id = 1;
  // Job status: pending, in_progress, completed, failed
  string status = 2;
  // Extraction progress (0-100)
  int32 progress_percent = 3;
  // Number of pages extracted so far
  int32 pages_processed = 4;
  // Total pages in document
  int32 total_pages = 5;
  // Error details if status is failed
  string error_message = 6;
}
