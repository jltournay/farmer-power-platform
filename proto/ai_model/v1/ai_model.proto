// AI Model Service - gRPC API Definition
// LLM extraction gateway for all domain models
// Story 0.75.5: Added CostService for LLM cost observability
// Story 13.7: CostService DEPRECATED - use platform-cost service instead (ADR-016)

syntax = "proto3";

package farmer_power.ai_model.v1;

import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";

// AiModelService provides LLM-based extraction capabilities
service AiModelService {
  // Extract structured data from raw content using LLM
  rpc Extract(ExtractionRequest) returns (ExtractionResponse);

  // Health check for service readiness
  rpc HealthCheck(HealthCheckRequest) returns (HealthCheckResponse);
}

// DEPRECATED: CostService has been removed from ai-model (Story 13.7, ADR-016).
// Cost tracking is now handled by platform-cost service via DAPR pub/sub.
// Use platform_cost.v1.UnifiedCostService for cost queries.
//
// Keeping these message definitions for backward compatibility with any
// existing clients. The service implementation has been removed.
//
// service CostService {
//   rpc GetDailyCostSummary(DateRangeRequest) returns (DailyCostSummaryResponse);
//   rpc GetCurrentDayCost(google.protobuf.Empty) returns (CostSummaryResponse);
//   rpc GetCostByAgentType(DateRangeRequest) returns (CostByAgentTypeResponse);
//   rpc GetCostByModel(DateRangeRequest) returns (CostByModelResponse);
//   rpc GetCostAlerts(google.protobuf.Empty) returns (CostAlertsResponse);
//   rpc ConfigureCostThreshold(ThresholdConfigRequest) returns (google.protobuf.Empty);
// }

// ============================================
// Extraction Service Messages
// ============================================

message ExtractionRequest {
  // Raw content to extract from (JSON, text, etc.)
  string raw_content = 1;

  // AI agent ID from source configuration (e.g., "qc-exception-extraction-agent")
  string ai_agent_id = 2;

  // Source configuration hints for extraction
  string source_config_json = 3;

  // MIME type of the content
  string content_type = 4;

  // OpenTelemetry trace ID for distributed tracing
  string trace_id = 5;
}

message ExtractionResponse {
  // Whether extraction succeeded
  bool success = 1;

  // Extracted fields as JSON
  string extracted_fields_json = 2;

  // Confidence score of the extraction (0.0-1.0)
  float confidence = 3;

  // Whether extraction passed semantic validation
  bool validation_passed = 4;

  // Validation warnings (non-blocking issues)
  repeated string validation_warnings = 5;

  // Error message if success=false
  string error_message = 6;
}

message HealthCheckRequest {}

message HealthCheckResponse {
  bool healthy = 1;
  string version = 2;
}

// ============================================
// Cost Service Messages (Story 0.75.5)
// DEPRECATED: Use platform_cost.v1.UnifiedCostService instead (Story 13.7, ADR-016)
// Kept for backward compatibility - may be removed in future version
// ============================================

message DateRangeRequest {
  google.protobuf.Timestamp start_date = 1;
  google.protobuf.Timestamp end_date = 2;
}

message CostSummaryResponse {
  // Total cost in USD (string for Decimal precision)
  string total_cost_usd = 1;
  int64 total_requests = 2;
  int64 total_tokens_in = 3;
  int64 total_tokens_out = 4;
}

message DailyCost {
  google.protobuf.Timestamp date = 1;
  string total_cost_usd = 2;
  int64 total_requests = 3;
  int64 total_tokens_in = 4;
  int64 total_tokens_out = 5;
  int64 success_count = 6;
  int64 failure_count = 7;
}

message DailyCostSummaryResponse {
  repeated DailyCost daily_costs = 1;
}

message AgentTypeCostEntry {
  string agent_type = 1;
  string total_cost_usd = 2;
  int64 total_requests = 3;
  int64 total_tokens = 4;
}

message CostByAgentTypeResponse {
  repeated AgentTypeCostEntry agent_type_costs = 1;
}

message ModelCostEntry {
  string model = 1;
  string total_cost_usd = 2;
  int64 total_requests = 3;
  int64 total_tokens = 4;
}

message CostByModelResponse {
  repeated ModelCostEntry model_costs = 1;
}

message CostAlert {
  // Type of threshold: "daily" or "monthly"
  string threshold_type = 1;
  // Configured threshold in USD
  string threshold_usd = 2;
  // Current cost when alert was triggered
  string current_cost_usd = 3;
  // When the alert was triggered
  google.protobuf.Timestamp triggered_at = 4;
  // ID of the cost event that triggered the alert
  string event_id = 5;
}

message CostAlertsResponse {
  repeated CostAlert alerts = 1;
  // Current budget status
  string daily_threshold_usd = 2;
  string daily_total_usd = 3;
  bool daily_alert_triggered = 4;
  string monthly_threshold_usd = 5;
  string monthly_total_usd = 6;
  bool monthly_alert_triggered = 7;
}

message ThresholdConfigRequest {
  // New daily threshold in USD (0 = disabled, -1 = no change)
  double daily_threshold_usd = 1;
  // New monthly threshold in USD (0 = disabled, -1 = no change)
  double monthly_threshold_usd = 2;
}

// ============================================
// RAG Document Service (Story 0.75.10)
// Manages RAG knowledge documents with versioning
// ============================================

// RAGDocumentService provides RAG document management capabilities
service RAGDocumentService {
  // CRUD Operations
  rpc CreateDocument(CreateDocumentRequest) returns (CreateDocumentResponse);
  rpc GetDocument(GetDocumentRequest) returns (RAGDocument);
  rpc UpdateDocument(UpdateDocumentRequest) returns (RAGDocument);
  rpc DeleteDocument(DeleteDocumentRequest) returns (DeleteDocumentResponse);

  // List & Search
  rpc ListDocuments(ListDocumentsRequest) returns (ListDocumentsResponse);
  rpc SearchDocuments(SearchDocumentsRequest) returns (SearchDocumentsResponse);

  // Lifecycle Management
  rpc StageDocument(StageDocumentRequest) returns (RAGDocument);
  rpc ActivateDocument(ActivateDocumentRequest) returns (RAGDocument);
  rpc ArchiveDocument(ArchiveDocumentRequest) returns (RAGDocument);
  rpc RollbackDocument(RollbackDocumentRequest) returns (RAGDocument);

  // Extraction Operations (Story 0.75.10b)
  rpc ExtractDocument(ExtractDocumentRequest) returns (ExtractDocumentResponse);
  rpc GetExtractionJob(GetExtractionJobRequest) returns (ExtractionJobResponse);
  rpc StreamExtractionProgress(StreamExtractionProgressRequest) returns (stream ExtractionProgressEvent);

  // Chunking Operations (Story 0.75.10d)
  rpc ChunkDocument(ChunkDocumentRequest) returns (ChunkDocumentResponse);
  rpc ListChunks(ListChunksRequest) returns (ListChunksResponse);
  rpc GetChunk(GetChunkRequest) returns (RagChunk);
  rpc DeleteChunks(DeleteChunksRequest) returns (DeleteChunksResponse);

  // Vectorization Operations (Story 0.75.13b)
  rpc VectorizeDocument(VectorizeDocumentRequest) returns (VectorizeDocumentResponse);
  rpc GetVectorizationJob(GetVectorizationJobRequest) returns (VectorizationJobResponse);

  // Query Operations (Story 0.75.23)
  // Query knowledge base with natural language for RAG retrieval
  rpc QueryKnowledge(QueryKnowledgeRequest) returns (QueryKnowledgeResponse);
}

// ============================================
// RAG Document Messages
// ============================================

// RAG knowledge document for expert knowledge storage
// Documents are versioned via document_id + version combination
message RAGDocument {
  // Unique document ID (format: {document_id}:v{version}) - MongoDB _id mapping
  string id = 1;
  // Stable ID across versions (e.g., "disease-diagnosis-guide")
  string document_id = 2;
  // Incrementing version number
  int32 version = 3;
  // Document title for display
  string title = 4;
  // Knowledge domain: plant_diseases, tea_cultivation, weather_patterns, quality_standards, regional_context
  string domain = 5;
  // Extracted/authored markdown text content
  string content = 6;
  // Document lifecycle status: draft, staged, active, archived
  string status = 7;
  // Document metadata
  RAGDocumentMetadata metadata = 8;
  // Original file reference if uploaded as PDF/DOCX
  SourceFile source_file = 9;
  // What changed from previous version
  string change_summary = 10;
  // Creation timestamp
  google.protobuf.Timestamp created_at = 11;
  // Last update timestamp
  google.protobuf.Timestamp updated_at = 12;
  // Pinecone namespace (e.g., "knowledge-v12")
  string pinecone_namespace = 13;
  // Vector IDs in Pinecone after vectorization
  repeated string pinecone_ids = 14;
  // SHA256 hash for change detection
  string content_hash = 15;
}

// Metadata for RAG document
message RAGDocumentMetadata {
  // Agronomist who created/updated the document
  string author = 1;
  // Original source (book, research paper, etc.)
  string source = 2;
  // Geographic relevance (e.g., "Kenya", "Rwanda")
  string region = 3;
  // Seasonal relevance (e.g., "dry_season", "monsoon")
  string season = 4;
  // Searchable tags for filtering
  repeated string tags = 5;
}

// Original uploaded file reference for PDF/DOCX uploads
message SourceFile {
  // Original filename (e.g., "blister-blight-guide.pdf")
  string filename = 1;
  // File type: pdf, docx, md, txt
  string file_type = 2;
  // Azure Blob path to original file
  string blob_path = 3;
  // File size in bytes
  int64 file_size_bytes = 4;
  // Extraction method: manual, text_extraction, azure_doc_intel, vision_llm
  string extraction_method = 5;
  // Extraction quality score (0-1)
  float extraction_confidence = 6;
  // Number of pages in document
  int32 page_count = 7;
}

// ============================================
// CRUD Request/Response Messages
// ============================================

message CreateDocumentRequest {
  // Stable document ID (optional - auto-generated UUID if not provided)
  string document_id = 1;
  // Document title for display
  string title = 2;
  // Knowledge domain: plant_diseases, tea_cultivation, weather_patterns, quality_standards, regional_context
  string domain = 3;
  // Document content (markdown text)
  string content = 4;
  // Document metadata
  RAGDocumentMetadata metadata = 5;
  // Optional source file reference
  SourceFile source_file = 6;
  // Optional raw file bytes for blob storage upload (PDF, DOCX)
  bytes file_content = 7;
}

message CreateDocumentResponse {
  // Created document
  RAGDocument document = 1;
}

message GetDocumentRequest {
  // Document ID to retrieve
  string document_id = 1;
  // Optional: specific version to retrieve (0 = active version)
  int32 version = 2;
}

message UpdateDocumentRequest {
  // Document ID to update
  string document_id = 1;
  // Updated title (empty = no change)
  string title = 2;
  // Updated content (empty = no change)
  string content = 3;
  // Updated metadata (null = no change)
  RAGDocumentMetadata metadata = 4;
  // Summary of what changed
  string change_summary = 5;
}

message DeleteDocumentRequest {
  // Document ID to delete (archives all versions)
  string document_id = 1;
}

message DeleteDocumentResponse {
  // Number of versions archived
  int32 versions_archived = 1;
}

// ============================================
// List & Search Request/Response Messages
// ============================================

message ListDocumentsRequest {
  // Page number (1-indexed, default 1)
  int32 page = 1;
  // Page size (default 20, max 100)
  int32 page_size = 2;
  // Filter by domain
  string domain = 3;
  // Filter by status
  string status = 4;
  // Filter by author
  string author = 5;
}

message ListDocumentsResponse {
  // Documents for this page
  repeated RAGDocument documents = 1;
  // Total count matching filters
  int32 total_count = 2;
  // Current page number
  int32 page = 3;
  // Page size used
  int32 page_size = 4;
}

message SearchDocumentsRequest {
  // Search query (searches title and content)
  string query = 1;
  // Filter by domain
  string domain = 2;
  // Filter by status
  string status = 3;
  // Max results to return (default 20, max 100)
  int32 limit = 4;
}

message SearchDocumentsResponse {
  // Matching documents
  repeated RAGDocument documents = 1;
}

// ============================================
// Lifecycle Request Messages
// ============================================

message StageDocumentRequest {
  // Document ID to stage
  string document_id = 1;
  // Version to stage (must be in draft status)
  int32 version = 2;
}

message ActivateDocumentRequest {
  // Document ID to activate
  string document_id = 1;
  // Version to activate (must be in staged status)
  int32 version = 2;
}

message ArchiveDocumentRequest {
  // Document ID to archive
  string document_id = 1;
  // Version to archive (optional - 0 archives all versions)
  int32 version = 2;
}

message RollbackDocumentRequest {
  // Document ID to rollback
  string document_id = 1;
  // Version to rollback to (creates new draft version with content from this version)
  int32 target_version = 2;
}

// ============================================
// Extraction Request/Response Messages (Story 0.75.10b)
// ============================================

message ExtractDocumentRequest {
  // Document ID to extract content from
  string document_id = 1;
  // Optional: specific version to extract (0 = latest version)
  int32 version = 2;
}

message ExtractDocumentResponse {
  // Job ID for tracking extraction progress
  string job_id = 1;
}

message GetExtractionJobRequest {
  // Job ID to retrieve status for
  string job_id = 1;
}

message ExtractionJobResponse {
  // Unique job identifier
  string job_id = 1;
  // RAG document being extracted
  string document_id = 2;
  // Job status: pending, in_progress, completed, failed
  string status = 3;
  // Extraction progress (0-100)
  int32 progress_percent = 4;
  // Number of pages extracted so far
  int32 pages_processed = 5;
  // Total pages in document (0 if unknown)
  int32 total_pages = 6;
  // Error details if status is failed
  string error_message = 7;
  // Job start timestamp
  google.protobuf.Timestamp started_at = 8;
  // Job completion timestamp (if completed or failed)
  google.protobuf.Timestamp completed_at = 9;
}

message StreamExtractionProgressRequest {
  // Job ID to stream progress for
  string job_id = 1;
}

message ExtractionProgressEvent {
  // Unique job identifier
  string job_id = 1;
  // Job status: pending, in_progress, completed, failed
  string status = 2;
  // Extraction progress (0-100)
  int32 progress_percent = 3;
  // Number of pages extracted so far
  int32 pages_processed = 4;
  // Total pages in document
  int32 total_pages = 5;
  // Error details if status is failed
  string error_message = 6;
}

// ============================================
// Chunking Request/Response Messages (Story 0.75.10d)
// ============================================

// Individual chunk of a RAG document for vectorization
message RagChunk {
  // Unique chunk identifier (format: {document_id}-v{version}-chunk-{index})
  string chunk_id = 1;
  // Parent document ID
  string document_id = 2;
  // Parent document version
  int32 document_version = 3;
  // Position in document (0-indexed)
  int32 chunk_index = 4;
  // Chunk text content
  string content = 5;
  // Heading this chunk belongs to (null if no heading)
  string section_title = 6;
  // Word count for statistics
  int32 word_count = 7;
  // Character count for statistics
  int32 char_count = 8;
  // Creation timestamp
  google.protobuf.Timestamp created_at = 9;
  // Vector ID in Pinecone after vectorization (null if not vectorized)
  string pinecone_id = 10;
}

message ChunkDocumentRequest {
  // Document ID to chunk
  string document_id = 1;
  // Optional: specific version to chunk (0 = latest version)
  int32 version = 2;
}

message ChunkDocumentResponse {
  // Number of chunks created
  int32 chunks_created = 1;
  // Total character count of all chunks
  int32 total_char_count = 2;
  // Total word count of all chunks
  int32 total_word_count = 3;
}

message ListChunksRequest {
  // Document ID to list chunks for
  string document_id = 1;
  // Document version to list chunks for
  int32 version = 2;
  // Page number (1-indexed, default 1)
  int32 page = 3;
  // Page size (default 50, max 100)
  int32 page_size = 4;
}

message ListChunksResponse {
  // Chunks for this page
  repeated RagChunk chunks = 1;
  // Total count of chunks for this document version
  int32 total_count = 2;
  // Current page number
  int32 page = 3;
  // Page size used
  int32 page_size = 4;
}

message GetChunkRequest {
  // Chunk ID to retrieve
  string chunk_id = 1;
}

message DeleteChunksRequest {
  // Document ID to delete chunks for
  string document_id = 1;
  // Document version to delete chunks for
  int32 version = 2;
}

message DeleteChunksResponse {
  // Number of chunks deleted
  int32 chunks_deleted = 1;
}

// ============================================
// Vectorization Messages (Story 0.75.13b)
// ============================================

message VectorizeDocumentRequest {
  // Document ID to vectorize
  string document_id = 1;
  // Document version to vectorize (0 = latest)
  int32 version = 2;
  // Optional: Run async and return job_id immediately
  bool async = 3;
}

message VectorizeDocumentResponse {
  // Job ID for tracking (always set)
  string job_id = 1;
  // Final status (set only for sync mode)
  string status = 2;
  // Pinecone namespace where vectors were stored
  string namespace = 3;
  // Number of chunks vectorized
  int32 chunks_total = 4;
  // Number of chunks successfully embedded
  int32 chunks_embedded = 5;
  // Number of chunks successfully stored in Pinecone
  int32 chunks_stored = 6;
  // Number of chunks that failed
  int32 failed_count = 7;
  // SHA256 content hash of vectorized content
  string content_hash = 8;
  // Error message if status is failed/partial
  string error_message = 9;
}

message GetVectorizationJobRequest {
  // Job ID to retrieve status for
  string job_id = 1;
}

message VectorizationJobResponse {
  // Job ID
  string job_id = 1;
  // Current status: pending, in_progress, completed, failed, partial
  string status = 2;
  // Document ID being vectorized
  string document_id = 3;
  // Document version being vectorized
  int32 document_version = 4;
  // Pinecone namespace
  string namespace = 5;
  // Progress metrics
  int32 chunks_total = 6;
  int32 chunks_embedded = 7;
  int32 chunks_stored = 8;
  int32 failed_count = 9;
  // SHA256 content hash (set on completion)
  string content_hash = 10;
  // Error message if failed
  string error_message = 11;
  // Timestamps
  google.protobuf.Timestamp started_at = 12;
  google.protobuf.Timestamp completed_at = 13;
}

// ============================================
// Query Knowledge Messages (Story 0.75.23)
// RAG-based knowledge retrieval
// ============================================

// Request for querying the knowledge base with natural language
message QueryKnowledgeRequest {
  // Natural language query text
  string query = 1;
  // Knowledge domains to search (empty = all domains)
  repeated string domains = 2;
  // Maximum number of results (default 5, max 100)
  int32 top_k = 3;
  // Minimum similarity threshold (0.0-1.0, default 0.0)
  float confidence_threshold = 4;
  // Pinecone namespace for version isolation (optional)
  string namespace = 5;
}

// Response containing retrieval matches
message QueryKnowledgeResponse {
  // List of matching chunks ordered by similarity
  repeated RetrievalMatch matches = 1;
  // Original query echoed back
  string query = 2;
  // Namespace that was queried
  string namespace = 3;
  // Total matches before confidence filtering
  int32 total_matches = 4;
}

// Single match from a retrieval query
message RetrievalMatch {
  // Unique chunk identifier
  string chunk_id = 1;
  // Full chunk text content
  string content = 2;
  // Similarity score (0-1, higher is more similar)
  float score = 3;
  // Parent document ID for attribution
  string document_id = 4;
  // Document title for display
  string title = 5;
  // Knowledge domain of the chunk
  string domain = 6;
  // Additional metadata as JSON string
  string metadata_json = 7;
}

// ============================================================================
// Agent Config Service - Read-only admin visibility (ADR-019)
// Story 9.12a: Provides read-only access to AI agent configurations and prompts
// Write operations are handled by agent-config and prompt-config CLIs
// ============================================================================

// AgentConfigService provides read-only queries for AI agent configurations
service AgentConfigService {
  // List all agent configurations with optional filters
  rpc ListAgentConfigs(ListAgentConfigsRequest) returns (ListAgentConfigsResponse);

  // Get a single agent configuration with its linked prompts
  rpc GetAgentConfig(GetAgentConfigRequest) returns (AgentConfigResponse);

  // List prompts for a specific agent
  rpc ListPromptsByAgent(ListPromptsByAgentRequest) returns (ListPromptsResponse);

  // Get full prompt detail including content (Story 9.12c - AC 9.12c.4)
  rpc GetPrompt(GetPromptRequest) returns (PromptDetail);
}

// ============================================
// Agent Config Request/Response Messages
// ============================================

message ListAgentConfigsRequest {
  // Max results per page (default 20, max 100)
  int32 page_size = 1;
  // Pagination cursor (skip count encoded as string)
  string page_token = 2;
  // Filter by agent type: "extractor", "explorer", "generator", "conversational", "tiered-vision"
  string agent_type = 3;
  // Filter by status: "draft", "staged", "active", "archived"
  string status = 4;
}

message ListAgentConfigsResponse {
  // List of agent config summaries
  repeated AgentConfigSummary agents = 1;
  // Token for next page (empty if no more results)
  string next_page_token = 2;
  // Total count of matching records
  int32 total_count = 3;
}

message GetAgentConfigRequest {
  // Agent identifier (e.g., "disease-diagnosis")
  string agent_id = 1;
  // Optional: specific version to retrieve (empty = active version)
  string version = 2;
}

message AgentConfigSummary {
  // Agent identifier (e.g., "disease-diagnosis")
  string agent_id = 1;
  // Semantic version string (e.g., "1.0.0")
  string version = 2;
  // Agent type: "extractor", "explorer", "generator", "conversational", "tiered-vision"
  string agent_type = 3;
  // Lifecycle status: "draft", "staged", "active", "archived"
  string status = 4;
  // Human-readable description
  string description = 5;
  // LLM model identifier (e.g., "anthropic/claude-3-5-sonnet")
  string model = 6;
  // Number of linked prompts
  int32 prompt_count = 7;
  // Last update timestamp
  google.protobuf.Timestamp updated_at = 8;
}

message AgentConfigResponse {
  // Agent identifier
  string agent_id = 1;
  // Semantic version string
  string version = 2;
  // Agent type
  string agent_type = 3;
  // Lifecycle status
  string status = 4;
  // Human-readable description
  string description = 5;
  // Full config as JSON string for detail view
  string config_json = 6;
  // Linked prompts (denormalized for single call efficiency)
  repeated PromptSummary prompts = 7;
  // Creation timestamp
  google.protobuf.Timestamp created_at = 8;
  // Last update timestamp
  google.protobuf.Timestamp updated_at = 9;
}

// ============================================
// Prompt Messages for AgentConfigService
// ============================================

message ListPromptsByAgentRequest {
  // Agent identifier to list prompts for
  string agent_id = 1;
  // Optional filter by status: "draft", "staged", "active", "archived"
  string status = 2;
}

message ListPromptsResponse {
  // List of prompt summaries
  repeated PromptSummary prompts = 1;
  // Total count of matching prompts
  int32 total_count = 2;
}

message PromptSummary {
  // Unique document ID (format: {prompt_id}:{version})
  string id = 1;
  // Logical prompt identifier (e.g., "disease-diagnosis")
  string prompt_id = 2;
  // Agent this prompt belongs to
  string agent_id = 3;
  // Semantic version string
  string version = 4;
  // Lifecycle status: "draft", "staged", "active", "archived"
  string status = 5;
  // Author username
  string author = 6;
  // Last update timestamp
  google.protobuf.Timestamp updated_at = 7;
}

// ============================================
// Prompt Detail Messages (Story 9.12c - AC 9.12c.4)
// Full prompt content for inline expansion view
// ============================================

message GetPromptRequest {
  // Prompt identifier (e.g., "disease-diagnosis")
  string prompt_id = 1;
  // Semantic version (optional - empty = active version)
  string version = 2;
}

message PromptDetail {
  // Unique document ID (format: {prompt_id}:{version})
  string id = 1;
  // Logical prompt identifier
  string prompt_id = 2;
  // Agent this prompt belongs to
  string agent_id = 3;
  // Semantic version string
  string version = 4;
  // Lifecycle status
  string status = 5;
  // Author username
  string author = 6;
  // Last update timestamp
  google.protobuf.Timestamp updated_at = 7;
  // Creation timestamp
  google.protobuf.Timestamp created_at = 8;
  // What changed in this version
  string changelog = 9;
  // Source commit SHA for traceability
  string git_commit = 10;
  // Full system prompt text
  string system_prompt = 11;
  // Template with {{variables}}
  string template = 12;
  // Output schema as JSON string
  string output_schema_json = 13;
  // Few-shot examples as JSON array string
  string few_shot_examples_json = 14;
  // A/B test enabled flag
  bool ab_test_enabled = 15;
  // A/B test traffic percentage (0-100)
  float ab_test_traffic_percentage = 16;
}
