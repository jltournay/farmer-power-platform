# Leaf Quality Analyzer - Tiered-Vision Agent Configuration
# Story 0.75.22: Tiered-Vision Agent Implementation
#
# Cost-optimized image analysis for tea leaf quality using tiered LLM processing:
# - Tier 1 (Screen): Fast Haiku classification on thumbnail/small image
# - Tier 2 (Diagnose): Deep Sonnet analysis on full image (only when needed)
#
# MCP Integration:
# - Images are fetched via Collection MCP (not passed as input)
# - Thumbnails are pre-generated by Collection Model (Story 2.13)
# - Supports both has_thumbnail=true (fetch thumbnail) and has_thumbnail=false (use original)
#
# See: _bmad-output/architecture/ai-model-architecture/agent-types.md @ Tiered-Vision Type
# Reference: TieredVisionConfig in services/ai-model/src/ai_model/domain/agent_config.py:484-542

id: "leaf-quality-analyzer:1.0.0"
agent_id: "leaf-quality-analyzer"
version: "1.0.0"
type: tiered-vision
status: active
description: "Cost-optimized image analysis for tea leaf quality using tiered LLM processing"

# Input contract (MCP-based - Story 0.75.22)
input:
  event: "ai.agent.requested"
  schema:
    type: object
    required:
      - doc_id
    properties:
      doc_id:
        type: string
        description: "Document ID from Collection Model (required for MCP image fetching)"
      has_thumbnail:
        type: boolean
        default: true
        description: "Whether document has pre-generated thumbnail (determines fetch strategy)"
      image_mime_type:
        type: string
        default: "image/jpeg"
        description: "MIME type of the image (e.g., 'image/jpeg', 'image/png')"
      farmer_context:
        type: object
        description: "Optional farmer context for enhanced diagnosis"
        properties:
          farmer_id:
            type: string
            description: "Farmer identifier for context"
          region:
            type: string
            description: "Region identifier (e.g., 'Kericho-High')"
          altitude_band:
            type: string
            enum: ["low", "medium", "high"]

# Output contract
output:
  event: "ai.agent.leaf-quality-analyzer.completed"
  schema:
    type: object
    required:
      - classification
      - confidence
      - success
    properties:
      classification:
        type: string
        description: "Final classification (e.g., 'healthy', 'tea_blister_blight', 'red_spider_mite_infestation')"
      confidence:
        type: number
        minimum: 0
        maximum: 1
        description: "Final confidence score (0.0-1.0)"
      severity:
        type: string
        enum: ["low", "moderate", "high", "critical"]
        description: "Issue severity (only for non-healthy classifications)"
      tier1:
        type: object
        description: "Tier 1 (screen) execution details"
        properties:
          executed:
            type: boolean
          result:
            type: object
            properties:
              classification:
                type: string
                enum: ["healthy", "obvious_issue", "uncertain"]
              confidence:
                type: number
              preliminary_findings:
                type: array
                items:
                  type: string
              skip_reason:
                type: string
      tier2:
        type: object
        description: "Tier 2 (diagnose) execution details"
        properties:
          executed:
            type: boolean
          skip_reason:
            type: string
          result:
            type: object
            properties:
              primary_issue:
                type: string
              confidence:
                type: number
              detailed_findings:
                type: array
                items:
                  type: string
              recommendations:
                type: array
                items:
                  type: string
              severity:
                type: string
      recommendations:
        type: array
        items:
          type: string
        description: "Treatment recommendations (from Tier 2 if executed)"
      detailed_findings:
        type: array
        items:
          type: string
        description: "Detailed findings (from Tier 2 if executed)"
      success:
        type: boolean
        description: "Whether analysis completed successfully"
      error_message:
        type: string
        description: "Error message if analysis failed"

# LLM configuration (null for tiered-vision - uses tiered_llm instead)
llm: null

# Tiered LLM configuration
tiered_llm:
  # Tier 1: Fast screening on thumbnail
  screen:
    model: "anthropic/claude-3-haiku"
    temperature: 0.1  # Low temperature for consistent classification
    max_tokens: 200   # Brief classification output
  # Tier 2: Deep diagnosis on full image
  diagnose:
    model: "anthropic/claude-3-5-sonnet"
    temperature: 0.3  # Slightly higher for nuanced diagnosis
    max_tokens: 2000  # Detailed analysis output

# Routing configuration (determines Tier 2 escalation)
routing:
  screen_threshold: 0.7      # Escalate if confidence < 0.7
  healthy_skip_threshold: 0.85  # Skip Tier 2 for healthy + confidence >= 0.85
  obvious_skip_threshold: 0.75  # Skip Tier 2 for obvious_issue + confidence >= 0.75

# RAG configuration (used in Tier 2 diagnosis only)
rag:
  enabled: true
  query_template: "tea leaf disease symptoms: {{preliminary_findings}} visual indicators: {{visual_symptoms}}"
  knowledge_domains:
    - tea-disease
    - plant-pathology
    - visual-symptoms
  top_k: 5
  min_similarity: 0.7

# MCP sources for image fetching (Story 0.75.22)
mcp_sources:
  - server: collection-mcp
    tools:
      - get_document_thumbnail  # For Tier 1 when has_thumbnail=true
      - get_document_image      # For Tier 2 or when has_thumbnail=false

# Error handling
error_handling:
  max_attempts: 3
  backoff_ms: [100, 500, 2000]
  on_failure: publish_error_event
  dead_letter_topic: null

# Metadata
metadata:
  author: "dev-story-0.75.22"
  created_at: "2026-01-11T00:00:00Z"
  updated_at: "2026-01-11T00:00:00Z"
  git_commit: null
