source_id: qc-analyzer-exceptions
display_name: QC Analyzer - Exception Images
description: Secondary leaf images requiring manual review or AI analysis

ingestion:
  mode: blob_trigger
  landing_container: qc-analyzer-landing
  processor_type: zip-extraction  # TODO: Implement ZipExtractionProcessor in future story
  path_pattern:
    pattern: "exceptions/{plantation_id}/{batch_id}.zip"
    extract_fields:
      - plantation_id
      - batch_id
  file_pattern: "*.zip"
  file_format: zip
  trigger_mechanism: event_grid
  processed_file_config:
    action: archive
    archive_container: qc-archive
    archive_ttl_days: 365
  zip_config:
    manifest_file: manifest.json
    images_folder: images
    extract_images: true
    image_storage_container: exception-images

validation:
  schema_name: data/qc-exceptions-manifest.json
  strict: true

transformation:
  ai_agent_id: qc-exception-extraction-agent
  extract_fields:
    - plantation_id
    - batch_id
    - batch_result_ref
    - exception_count
    - exception_images
  link_field: batch_result_ref
  field_mappings:
    plantation_id: farmer_id

storage:
  raw_container: exception-images-raw
  index_collection: exception_images_index
  ttl_days: 365

events:
  on_success:
    topic: collection.exception_images.received
    payload_fields:
      - document_id
      - plantation_id
      - batch_id
      - exception_count
  on_failure:
    topic: collection.exception_images.failed
    payload_fields:
      - source_id
      - error_type
      - error_message
