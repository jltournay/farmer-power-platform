# CI Pipeline for Farmer Power Platform
# Runs unit tests, integration tests (with MongoDB), and linting

name: CI

on:
  push:
    branches: ['**']
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "20"

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install linting dependencies
        run: pip install ruff
      - name: Run ruff check
        run: ruff check .
      - name: Run ruff format check
        run: ruff format --check .

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -e ".[test]" || pip install pytest pytest-asyncio pytest-cov pydantic pydantic-settings motor grpcio grpcio-tools tenacity \
            grpcio-health-checking grpcio-reflection \
            opentelemetry-api opentelemetry-sdk opentelemetry-exporter-otlp \
            opentelemetry-instrumentation-fastapi opentelemetry-instrumentation-grpc opentelemetry-instrumentation-pymongo \
            structlog httpx aiohttp fastapi uvicorn dapr dapr-ext-grpc langchain-core>=1.2 langchain-openai>=1.1 jsonschema \
            typer rich pyyaml deepdiff azure-storage-blob python-jose[cryptography] pymupdf azure-ai-documentintelligence pinecone \
            langgraph>=1.0.5 langgraph-checkpoint-mongodb>=0.3.0 "pymongo>=4.12,<4.16" Pillow

      - name: Run unit tests with coverage
        run: |
          PYTHONPATH="${PYTHONPATH}:libs/fp-common:libs/fp-proto/src:libs/fp-testing:services/plantation-model/src:services/collection-model/src:services/bff/src:services/ai-model/src:services/platform-cost/src:scripts/source-config/src:scripts/prompt-config/src:scripts/agent-config/src:scripts/knowledge-config/src:mcp-servers/plantation-mcp/src:mcp-servers/collection-mcp/src" \
            pytest tests/unit/ -v --cov=services --cov=libs --cov=mcp-servers --cov-report=term-missing --cov-report=xml

      - name: Extract coverage percentage
        id: coverage
        run: |
          # Extract coverage percentage from XML
          COVERAGE=$(python -c "
          import xml.etree.ElementTree as ET
          tree = ET.parse('coverage.xml')
          root = tree.getroot()
          line_rate = float(root.attrib.get('line-rate', 0))
          print(f'{line_rate * 100:.1f}')
          ")
          echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Backend Coverage: $COVERAGE%"

      - name: Update coverage badge
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_TOKEN }}
          gistID: ${{ vars.COVERAGE_GIST_ID }}
          filename: coverage.json
          label: coverage
          message: ${{ steps.coverage.outputs.percentage }}%
          valColorRange: ${{ steps.coverage.outputs.percentage }}
          minColorRange: 0
          maxColorRange: 100

  integration-tests:
    name: Integration Tests (MongoDB)
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27018:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -e ".[test]" || pip install pytest pytest-asyncio motor "pymongo>=4.12,<4.16" pydantic pydantic-settings grpcio grpcio-tools tenacity \
            grpcio-health-checking grpcio-reflection \
            opentelemetry-api opentelemetry-sdk opentelemetry-exporter-otlp \
            opentelemetry-instrumentation-fastapi opentelemetry-instrumentation-grpc opentelemetry-instrumentation-pymongo \
            structlog httpx aiohttp fastapi uvicorn dapr dapr-ext-grpc langchain-core>=1.2 langchain-openai>=1.1 jsonschema \
            azure-storage-blob pyyaml pymupdf pinecone Pillow \
            langgraph>=1.0.5 langgraph-checkpoint-mongodb>=0.3.0

      - name: Wait for MongoDB
        run: |
          for i in {1..30}; do
            if python -c "from pymongo import MongoClient; MongoClient('mongodb://localhost:27018', serverSelectionTimeoutMS=2000).admin.command('ping')" 2>/dev/null; then
              echo "MongoDB is ready"
              exit 0
            fi
            echo "Waiting for MongoDB... ($i/30)"
            sleep 2
          done
          echo "MongoDB failed to start"
          exit 1

      - name: Run integration tests
        env:
          MONGODB_TEST_URI: "mongodb://localhost:27018"
          MONGODB_TEST_PORT: "27018"
        run: |
          PYTHONPATH="${PYTHONPATH}:libs/fp-common:libs/fp-proto/src:libs/fp-testing:services/plantation-model/src:services/collection-model/src:services/bff/src:services/ai-model/src:services/platform-cost/src:scripts/source-config/src:scripts/prompt-config/src:scripts/agent-config/src:scripts/knowledge-config/src:mcp-servers/plantation-mcp/src:mcp-servers/collection-mcp/src" \
            pytest tests/integration/ -v -m mongodb --tb=short

  validate-e2e-evidence:
    name: Validate E2E Evidence in Story Files
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check story files for E2E evidence
        run: |
          echo "üîç Checking story files for E2E test evidence..."

          # Find story files modified in this PR
          STORY_FILES=$(git diff --name-only origin/main...HEAD | grep '_bmad-output/sprint-artifacts/.*\.md$' || true)

          if [ -z "$STORY_FILES" ]; then
            echo "‚úÖ No story files modified - skipping E2E validation"
            exit 0
          fi

          ERRORS=0

          for file in $STORY_FILES; do
            if [ ! -f "$file" ]; then
              continue
            fi

            echo "  Checking: $file"

            # Skip validation for stories that are not yet implemented
            # (ready-for-dev, draft status should not require E2E evidence)
            if grep -q "^\*\*Status:\*\* ready-for-dev\|^\*\*Status:\*\* draft" "$file" 2>/dev/null; then
              echo "  ‚è≠Ô∏è SKIPPED: $file has ready-for-dev/draft status (not yet implemented)"
              continue
            fi

            # Check for placeholder E2E evidence
            if grep -q "to be verified after push\|to be verified later\|E2E tests require Docker\|paste test output here\|paste E2E output here" "$file" 2>/dev/null; then
              echo "  ‚ùå FAILED: $file has placeholder E2E evidence"
              echo "     The dev agent must run actual E2E tests before pushing"
              ERRORS=$((ERRORS + 1))
            fi

            # Check if E2E Tests checkbox is unchecked
            if grep -q "\- \[ \].*E2E tests pass" "$file" 2>/dev/null; then
              echo "  ‚ùå FAILED: $file has unchecked E2E tests checkbox"
              ERRORS=$((ERRORS + 1))
            fi
          done

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo "‚õî E2E EVIDENCE VALIDATION FAILED"
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo ""
            echo "$ERRORS story file(s) are missing proper E2E test evidence."
            echo ""
            echo "The dev agent MUST:"
            echo "1. Run E2E tests locally with Docker"
            echo "2. Capture actual test output in the story file"
            echo "3. Mark the E2E checkbox as complete"
            echo ""
            exit 1
          fi

          echo "‚úÖ E2E evidence validated in all story files"

  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: |
          npm run lint -w @fp/ui-components
          npm run lint -w @fp/auth
          npm run lint -w @fp/factory-portal

      - name: Build libraries (required for factory-portal tests)
        run: |
          npm run build -w @fp/auth
          npm run build -w @fp/ui-components

      - name: Run tests with coverage
        run: |
          npm run test -w @fp/auth -- --coverage
          npm run test -w @fp/ui-components -- --coverage
          npm run test -w @fp/factory-portal -- --coverage

      - name: Calculate combined frontend coverage
        id: coverage
        run: |
          # Extract coverage from each package's json-summary
          AUTH_COV=$(node -e "const c=require('./libs/auth/coverage/coverage-summary.json'); console.log(c.total.lines.pct)")
          UI_COV=$(node -e "const c=require('./libs/ui-components/coverage/coverage-summary.json'); console.log(c.total.lines.pct)")
          PORTAL_COV=$(node -e "const c=require('./web/factory-portal/coverage/coverage-summary.json'); console.log(c.total.lines.pct)")

          # Calculate weighted average based on total lines
          AUTH_LINES=$(node -e "const c=require('./libs/auth/coverage/coverage-summary.json'); console.log(c.total.lines.total)")
          UI_LINES=$(node -e "const c=require('./libs/ui-components/coverage/coverage-summary.json'); console.log(c.total.lines.total)")
          PORTAL_LINES=$(node -e "const c=require('./web/factory-portal/coverage/coverage-summary.json'); console.log(c.total.lines.total)")

          COMBINED=$(node -e "
            const authCov = $AUTH_COV, uiCov = $UI_COV, portalCov = $PORTAL_COV;
            const authLines = $AUTH_LINES, uiLines = $UI_LINES, portalLines = $PORTAL_LINES;
            const totalLines = authLines + uiLines + portalLines;
            const weighted = (authCov * authLines + uiCov * uiLines + portalCov * portalLines) / totalLines;
            console.log(weighted.toFixed(1));
          ")
          echo "percentage=$COMBINED" >> $GITHUB_OUTPUT
          echo "Frontend Coverage: $COMBINED% (auth: $AUTH_COV%, ui: $UI_COV%, portal: $PORTAL_COV%)"

      - name: Update frontend coverage badge
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_TOKEN }}
          gistID: ${{ vars.COVERAGE_GIST_ID }}
          filename: frontend-coverage.json
          label: frontend coverage
          message: ${{ steps.coverage.outputs.percentage }}%
          valColorRange: ${{ steps.coverage.outputs.percentage }}
          minColorRange: 0
          maxColorRange: 100

      - name: Build factory-portal
        run: npm run build -w @fp/factory-portal

      - name: Build Storybook
        run: npm run build-storybook -w @fp/ui-components

  all-tests-pass:
    name: All Tests Pass
    needs: [lint, unit-tests, integration-tests, frontend-tests, validate-e2e-evidence]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.unit-tests.result }}" != "success" ] || \
             [ "${{ needs.integration-tests.result }}" != "success" ] || \
             [ "${{ needs.frontend-tests.result }}" != "success" ]; then
            echo "‚ùå Some required jobs failed"
            exit 1
          fi
          # validate-e2e-evidence only runs on PRs, so check if it ran and passed
          if [ "${{ needs.validate-e2e-evidence.result }}" != "success" ] && \
             [ "${{ needs.validate-e2e-evidence.result }}" != "skipped" ]; then
            echo "‚ùå E2E evidence validation failed"
            exit 1
          fi
          echo "‚úÖ All CI checks passed successfully!"
